<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ½å–å¡”ç½—ç‰Œ - Tarot09</title>
    <meta name="description" content="å·¦å³æ»‘åŠ¨é€‰æ‹©ä¸æ‚¨èƒ½é‡æ„Ÿåº”æœ€å¼ºçš„å¡”ç½—ç‰Œï¼Œè·å–å‘½è¿æŒ‡å¼•ã€‚">
    <link rel="stylesheet" href="css/styles.css">
    <!-- å¼•å…¥Font Awesomeå›¾æ ‡åº“ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="images/favicon.ico" type="image/x-icon">
    <style>
        /* å¡”ç½—ç‰ŒæŠ½å–é¡µé¢ä¸“ç”¨æ ·å¼ */
        .drawing-header {
            text-align: center;
            padding: 30px 0 15px;
        }
        
        .drawing-title {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 15px;
            line-height: 1.2;
        }
        
        .tarot-highlight {
            color: #FF69B4;
            font-weight: 700;
        }
        
        .drawing-subtitle {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 30px;
        }
        
        /* åœ¨çº¿æŠ½ç‰ŒæŒ‰é’® */
        .online-drawing-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            background-color: #8A2BE2;
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            margin: 0 auto 30px;
            width: fit-content;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(138, 43, 226, 0.2);
        }
        
        .online-drawing-btn:hover {
            background-color: #7926c9;
            transform: translateY(-2px);
        }
        
        .shuffle-icon {
            font-size: 1.2rem;
        }
        
        /* å¡ç‰Œæ»‘åŠ¨åŒºåŸŸ */
        .cards-slider-container {
            position: relative;
            overflow: hidden;
            max-width: 100%;
            margin: 0 auto 40px;
            padding: 20px 0;
        }
        
        /* å †å å¡ç‰ŒåŒºåŸŸæ ·å¼ */
        .cards-stack-container {
            position: relative;
            width: 95%;
            max-width: 1200px;
            height: 650px; /* å¢åŠ é«˜åº¦ä»500pxåˆ°650px */
            margin: 20px auto 40px;
            perspective: 1000px;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* æ”¹ä¸ºé¡¶éƒ¨å¯¹é½ */
            padding-top: 50px; /* æ·»åŠ é¡¶éƒ¨å†…è¾¹è·ï¼Œä½¿ç‰Œå †ä¸Šç§» */
            overflow: hidden;
            border: 2px solid #6541A5; /* æ·»åŠ åŸºç¡€è¾¹æ¡† */
            border-radius: 20px; /* åœ†è§’è¾¹æ¡† */
            background: linear-gradient(to bottom, rgba(28, 19, 71, 0.1), rgba(138, 43, 226, 0.05)); /* æ¸å˜èƒŒæ™¯ */
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15); /* é˜´å½±æ•ˆæœ */
            position: relative;
            /* ç§»é™¤æ‹–åŠ¨æŒ‡é’ˆæ ·å¼ */
        }
        
      
        
        /* æ·»åŠ æ˜Ÿæ˜Ÿè£…é¥° - ä½¿ç”¨ä¼ªå…ƒç´  */
        .cards-stack-container::before,
        .cards-stack-container::after {
            content: "";
            position: absolute;
            background-repeat: no-repeat;
            z-index: 1;
        }
        
        /* å·¦ä¸Šè§’æœˆäº®è£…é¥° */
        .cards-stack-container::before {
            top: 20px;
            left: 20px;
            width: 60px;
            height: 60px;
            background-image: radial-gradient(circle at 30% 30%, transparent 50%, #ffd700 51%, transparent 52%),
                              radial-gradient(circle at 70% 70%, #ffd700 10%, transparent 20%);
            opacity: 0.7;
        }
        
        /* å³ä¸Šè§’æ˜Ÿæ˜Ÿè£…é¥° */
        .cards-stack-container::after {
            top: 15px;
            right: 20px;
            width: 70px;
            height: 70px;
            background-image: 
                radial-gradient(circle at 20% 20%, #ffd700 2px, transparent 3px),
                radial-gradient(circle at 40% 60%, #ffd700 3px, transparent 4px),
                radial-gradient(circle at 70% 30%, #ffd700 4px, transparent 5px),
                radial-gradient(circle at 90% 80%, #ffd700 2px, transparent 3px),
                radial-gradient(circle at 10% 90%, #ffd700 3px, transparent 4px);
            opacity: 0.8;
        }
        
        /* æ·»åŠ é¢å¤–çš„æ˜Ÿæ˜Ÿè£…é¥° */
        .stars-decoration {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none; /* ç¡®ä¿ä¸ä¼šå¹²æ‰°å¡ç‰Œç‚¹å‡» */
            z-index: 1;
        }
        
        .star {
            position: absolute;
            width: 3px;
            height: 3px;
            background-color: #ffd700;
            border-radius: 50%;
            opacity: 0.6;
            animation: twinkle 4s infinite alternate;
        }
        
        .star:nth-child(1) { top: 15%; left: 10%; animation-delay: 0s; }
        .star:nth-child(2) { top: 25%; left: 85%; animation-delay: 0.5s; }
        .star:nth-child(3) { top: 65%; left: 20%; animation-delay: 1s; }
        .star:nth-child(4) { top: 80%; left: 70%; animation-delay: 1.5s; }
        .star:nth-child(5) { top: 40%; left: 90%; animation-delay: 2s; }
        .star:nth-child(6) { top: 30%; left: 25%; animation-delay: 2.5s; }
        .star:nth-child(7) { top: 75%; left: 40%; animation-delay: 3s; }
        .star:nth-child(8) { top: 90%; left: 10%; animation-delay: 3.5s; }
        
        @keyframes twinkle {
            0% { opacity: 0.2; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.5); }
            100% { opacity: 0.2; transform: scale(1); }
        }
        
        /* æ·»åŠ æœˆç›¸å›¾æ¡ˆ */
        .moon-phase {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(90deg, #1c1347 50%, #ffd700 50%);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            opacity: 0.7;
            pointer-events: none; /* ç¡®ä¿ä¸ä¼šå¹²æ‰°å¡ç‰Œç‚¹å‡» */
            z-index: 1;
        }
        
        .cards-stack {
            position: relative;
            width: 150px;
            height: 220px;
            transform-style: preserve-3d;
            transition: all 0.5s ease;
            cursor: pointer;
            margin-top: 30px; /* æ·»åŠ ä¸Šè¾¹è·ï¼Œè®©ç‰Œå †æ›´é ä¸Š */
        }
        
        .cards-stack.expanded {
            width: 100%;
            cursor: default;
            margin-top: 0; /* å±•å¼€åå–æ¶ˆä¸Šè¾¹è· */
        }
        
        .tarot-card {
            position: absolute;
            width: 130px;
            height: 200px;
            background-color: #1c1347; /* æ·±è“è‰²èƒŒæ™¯ */
            border: 5px solid #a897c2; /* æ·¡ç´«è‰²è¾¹æ¡† */
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25); /* å¢å¼ºé˜´å½±æ•ˆæœ */
            transition: all 0.5s ease;
            backface-visibility: hidden;
            transform-origin: center center;
            background-image: url('images/èƒŒé¢A.jpg'); /* ä½¿ç”¨æ–°çš„å¡èƒŒå›¾ç‰‡ */
            background-size: cover; /* ç¡®ä¿å›¾ç‰‡è¦†ç›–æ•´ä¸ªå¡ç‰Œ */
            background-position: center; /* å±…ä¸­æ˜¾ç¤ºå›¾ç‰‡ */
            overflow: hidden; /* ç¡®ä¿å›¾ç‰‡ä¸ä¼šæº¢å‡ºå¡ç‰Œè¾¹ç•Œ */
        }
        
        /* å¢å¼ºå¡ç‰ŒèƒŒé¢çš„å¤æ‚åº¦ï¼Œä½¿å…¶æ›´åƒå¡”ç½—ç‰Œ */
        .tarot-card::before {
            content: "";
            position: absolute;
            width: 95%;
            height: 95%;
            top: 2.5%;
            left: 2.5%;
            border: 2px solid rgba(255, 215, 0, 0.5); /* å¢å¼ºé‡‘è‰²è¾¹æ¡† */
            box-sizing: border-box;
            border-radius: 6px; /* æ·»åŠ åœ†è§’ */
            z-index: 1;
        }
        
        /* æ·»åŠ æ˜Ÿæ˜Ÿå›¾æ¡ˆç‚¹ç¼€ */
        /*
        .tarot-card-stars {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            background-image: 
                radial-gradient(circle at 20% 20%, rgba(255, 215, 0, 0.6) 1px, transparent 2px),
                radial-gradient(circle at 80% 20%, rgba(255, 215, 0, 0.6) 1px, transparent 2px),
                radial-gradient(circle at 20% 80%, rgba(255, 215, 0, 0.6) 1px, transparent 2px),
                radial-gradient(circle at 80% 80%, rgba(255, 215, 0, 0.6) 1px, transparent 2px),
                radial-gradient(circle at 50% 50%, rgba(255, 215, 0, 0.8) 2px, transparent 3px);
            z-index: 3;
        }
        
        /* æ·»åŠ æœˆç›¸å›¾æ¡ˆ */
        .tarot-card-moon {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(90deg, #1c1347 50%, rgba(255, 215, 0, 0.4) 50%);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
            z-index: 3;
        }
        
        /* æ·»åŠ å¡ç‰Œåº•éƒ¨ç¥ç§˜ç¬¦å· */
        .tarot-card-symbol {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 40px;
            background-image: 
                linear-gradient(0deg, transparent 45%, rgba(255, 215, 0, 0.4) 45%, rgba(255, 215, 0, 0.4) 55%, transparent 55%),
                linear-gradient(90deg, transparent 45%, rgba(255, 215, 0, 0.4) 45%, rgba(255, 215, 0, 0.4) 55%, transparent 55%);
            border-radius: 50%;
            z-index: 3;
        }
        */
        
        .tarot-card.selected {
            pointer-events: none;
        }
        
        .cards-counter {
            display: none;
        }
        
        .cards-slider {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            padding: 10px 5%;
            box-sizing: border-box;
            /* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™åŠŸèƒ½ */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
        }
        
        .cards-slider::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        
        .slider-card {
            flex: 0 0 auto;
            width: 130px;
            height: 200px;
            margin-right: 15px;
            scroll-snap-align: center;
            background-color: #33084d;
            border: 8px solid #6c4675;
            border-radius: 10px;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .slider-card:last-child {
            margin-right: 5%;
        }
        
        .slider-card:hover, .slider-card.active {
            transform: translateY(-15px);
        }
        
        .slider-card::before {
            content: "â™¦";
            color: #ffd700;
            font-size: 2rem;
        }
        
        .slider-card::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60%;
            height: 60%;
            border: 2px solid #ffd700;
            border-radius: 5px;
        }
        
        /* æ»‘åŠ¨æ¡ */
        .slider-track {
            width: 60%;
            height: 6px;
            background-color: #e0e0e0;
            border-radius: 3px;
            margin: 0 auto 40px;
            position: relative;
        }
        
        .slider-progress {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 30%;
            background-color: #8A2BE2;
            border-radius: 3px;
        }
        
        /* é‡æ–°æŠ½ç‰ŒæŒ‰é’® */
        .redraw-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            background-color: #f0f0f0;
            color: #333;
            border: none;
            border-radius: 25px;
            padding: 10px 20px;
            font-size: 0.9rem;
            margin: 0 auto 40px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: fit-content;
        }
        
        .redraw-button:hover {
            background-color: #e0e0e0;
        }
        
        .redraw-icon {
            color: #8A2BE2;
        }
        
        /* ç‰Œä½å±•ç¤ºåŒºåŸŸ - é‡æ–°å®šä½åˆ°æ‰‡å½¢å†…éƒ¨ */
        .card-positions {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            justify-content: center;
            flex-wrap: nowrap; /* é˜²æ­¢æ¢è¡Œ */
            gap: 15px;
            width: 80%;
            margin: 0 auto 20px;
            z-index: 900; /* ç¡®ä¿åœ¨å¡ç‰Œä¸Šæ–¹ */
        }
        
        .card-position {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 90px; /* ç¼©å°å®½åº¦ */
        }
        
        .position-placeholder {
            width: 70px; /* ç¼©å°å®½åº¦ */
            height: 110px; /* ç¼©å°é«˜åº¦ */
            border: 2px dashed #ccc;
            border-radius: 10px;
            margin-bottom: 10px;
            background-color: rgba(255, 255, 255, 0.7); /* åŠé€æ˜ç™½è‰²èƒŒæ™¯ */
        }
        
        .position-label {
            font-size: 0.8rem;
            color: #666;
            text-align: center;
            background-color: rgba(255, 255, 255, 0.7); /* åŠé€æ˜ç™½è‰²èƒŒæ™¯ */
            padding: 2px 5px;
            border-radius: 10px;
        }
        
        /* å¡”ç½—ç‰Œè§£è¯»å­ç•Œé¢æ ·å¼ */
        .reading-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .reading-container {
            width: 90%;
            max-width: 1000px;
            margin: 40px auto;
            background: linear-gradient(135deg, #1c1347 0%, #32236e 100%);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            padding: 30px;
            color: #fff;
            position: relative;
        }
        
        .reading-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        .reading-title {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #ffd700;
        }
        
        .reading-question {
            font-size: 1.2rem;
            font-style: italic;
            color: #d0d0d0;
            margin-bottom: 15px;
        }
        
        .reading-date {
            font-size: 0.9rem;
            color: #a0a0a0;
        }
        
        .cards-summary {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-bottom: 30px;
            gap: 15px;
        }
        
        .card-summary {
            width: 18%;
            min-width: 120px;
            text-align: center;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 15px 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .card-summary img {
            width: 80px;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid rgba(255, 215, 0, 0.5);
            margin-bottom: 10px;
        }
        
        .card-name {
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 5px;
        }
        
        .card-position-name {
            font-size: 0.8rem;
            color: #a0a0a0;
        }
        
        .reading-conversation {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .conversation-title {
            text-align: center;
            font-size: 1.4rem;
            margin-bottom: 20px;
            color: #ffd700;
        }
        
        .chat-messages {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 10px;
        }
        
        .message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }
        
        .message-tarot {
            align-self: flex-start;
            background: rgba(138, 43, 226, 0.4);
            border-radius: 15px 15px 15px 0;
            padding: 12px 15px;
            max-width: 80%;
            margin-bottom: 5px;
        }
        
        .message-user {
            align-self: flex-end;
            background: rgba(255, 215, 0, 0.3);
            border-radius: 15px 15px 0 15px;
            padding: 12px 15px;
            max-width: 80%;
            margin-bottom: 5px;
            text-align: right;
        }
        
        .message-info {
            font-size: 0.7rem;
            color: #a0a0a0;
        }
        
        .message-tarot-info {
            align-self: flex-start;
        }
        
        .message-user-info {
            align-self: flex-end;
        }
        
        .chat-input-container {
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 20px;
            padding: 10px 15px;
            color: #fff;
            font-size: 1rem;
        }
        
        .chat-input:focus {
            outline: none;
            border-color: rgba(255, 215, 0, 0.7);
        }
        
        .send-button {
            background: linear-gradient(135deg, #8A2BE2 0%, #4B0082 100%);
            border: none;
            border-radius: 20px;
            padding: 10px 20px;
            color: #fff;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease;
        }
        
        .send-button:hover {
            background: linear-gradient(135deg, #9b4dff 0%, #6c2eb1 100%);
            transform: translateY(-2px);
        }
        
        .reading-actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }
        
        .action-button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 20px;
            padding: 10px 20px;
            color: #fff;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .action-button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 215, 0, 0.7);
        }
        
        .action-icon {
            font-size: 1.2rem;
        }
        
        .close-reading {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: #a0a0a0;
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        
        .close-reading:hover {
            color: #fff;
        }
        
        @media (max-width: 768px) {
            .reading-container {
                width: 95%;
                padding: 20px 15px;
                margin: 20px auto;
            }
            
            .cards-summary {
                justify-content: center;
            }
            
            .card-summary {
                width: 40%;
                min-width: 100px;
                margin-bottom: 15px;
            }
            
            .reading-title {
                font-size: 1.6rem;
            }
            
            .reading-question {
                font-size: 1rem;
            }
        }

        /* AIè°ƒè¯•æ¨¡æ€çª—å£æ ·å¼ */
        .debug-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1100;
        }

        .debug-modal-content {
            position: relative;
            background: linear-gradient(135deg, #1c1347 0%, #32236e 100%);
            margin: 10% auto;
            padding: 20px;
            width: 80%;
            max-width: 600px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            color: #fff;
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            color: #a0a0a0;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-btn:hover {
            color: #fff;
        }

        .api-setting {
            margin: 15px 0;
        }

        .api-setting label {
            display: block;
            margin-bottom: 5px;
            color: #ffd700;
        }

        .api-setting input, .api-setting select, .api-setting textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .api-setting input:focus, .api-setting select:focus, .api-setting textarea:focus {
            outline: none;
            border-color: rgba(255, 215, 0, 0.7);
        }

        .btn {
            background: linear-gradient(135deg, #8A2BE2 0%, #4B0082 100%);
            border: none;
            border-radius: 20px;
            padding: 10px 20px;
            color: #fff;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease;
            margin-top: 15px;
            margin-right: 10px;
        }

        .btn:hover {
            background: linear-gradient(135deg, #9b4dff 0%, #6c2eb1 100%);
            transform: translateY(-2px);
        }

        .api-test-result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }

        .success {
            background: rgba(0, 255, 0, 0.2);
            border: 1px solid rgba(0, 255, 0, 0.5);
        }

        .error {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid rgba(255, 0, 0, 0.5);
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="container">
            <div class="logo">
                <a href="index.html">
                    <span>ğŸ”®</span>
                    <span>Tarot09</span>
                </a>
            </div>
            
            <button class="menu-toggle" aria-label="èœå•">
                <i class="fas fa-bars"></i>
            </button>
            
            <div class="nav-capsules">
                <!-- ä¸»å¯¼èˆªèƒ¶å›Š -->
                <div class="nav-capsule main-nav-capsule">
                    <div class="nav-menu">
                        <ul>
                            <li><a href="index.html" class="nav-link">é¦–é¡µ</a></li>
                            <li><a href="ai-taluopai.html" class="nav-link active">AIå¡”ç½—å åœ</a></li>
                            <li><a href="yes-no-tarot.html" class="nav-link">æ˜¯å¦å¡”ç½—å åœ</a></li>
                            <li><a href="javascript:void(0)" class="nav-link premium" id="premiumLink"><i class="fas fa-crown"></i> ä¼šå‘˜è®¢é˜…</a></li>
                        </ul>
                    </div>
                </div>
                
                <!-- ç”¨æˆ·æ§åˆ¶èƒ¶å›Š -->
                <div class="nav-capsule user-controls-capsule">
                    <div class="user-controls">
                        <button class="theme-toggle" aria-label="åˆ‡æ¢ä¸»é¢˜">
                            <i class="fas fa-moon"></i>
                            <i class="fas fa-sun"></i>
                        </button>
                        <button class="language-toggle" aria-label="åˆ‡æ¢è¯­è¨€">
                            <i class="fas fa-globe"></i>
                        </button>
                        <button class="debug-toggle" aria-label="è°ƒè¯•è®¾ç½®">
                            <i class="fas fa-cog"></i>
                        </button>
                        <a href="javascript:void(0)" class="user-profile">
                            ğŸ˜Š
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹ -->
    <main>
        <section class="drawing-header">
            <div class="container">
                <h1 class="drawing-title">
                    æŠ½å–æ‚¨çš„ <span class="tarot-highlight">å¡”ç½—ç‰Œ</span>
                </h1>
                <p class="drawing-subtitle">ç‚¹å‡»ç‰Œå †æŠ½å–ä¸æ‚¨èƒ½é‡æ„Ÿåº”æœ€å¼ºçš„å¡ç‰Œ</p>
            </div>
        </section>
        
        <!-- åœ¨çº¿æŠ½ç‰ŒæŒ‰é’® -->
        <div class="online-drawing-btn" id="onlineDrawingBtn">
            <i class="fas fa-random shuffle-icon"></i>
            <span>åœ¨çº¿æŠ½ç‰Œ</span>
        </div>
        
        <!-- å¡ç‰Œå †å åŒºåŸŸ -->
        <div class="cards-stack-container">
            <div class="cards-stack" id="cardsStack">
                <!-- 78å¼ å¡ç‰Œå°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <!-- æ·»åŠ æ˜Ÿæ˜Ÿè£…é¥° -->
            <div class="stars-decoration">
                <div class="star"></div>
                <div class="star"></div>
                <div class="star"></div>
                <div class="star"></div>
                <div class="star"></div>
                <div class="star"></div>
                <div class="star"></div>
                <div class="star"></div>
            </div>
            
            <!-- æ·»åŠ æœˆç›¸å›¾æ¡ˆ -->
            <div class="moon-phase"></div>
            
            <!-- ç‰Œä½å±•ç¤ºåŒºåŸŸ - ç§»åŠ¨åˆ°å¡ç‰Œå®¹å™¨å†…éƒ¨ -->
            <div class="card-positions">
                <div class="card-position">
                    <div class="position-placeholder" id="position1"></div>
                    <div class="position-label">å½“å‰çŠ¶æ€</div>
                </div>
                <div class="card-position">
                    <div class="position-placeholder" id="position2"></div>
                    <div class="position-label">æœªæ¥å‘å±•</div>
                </div>
                <div class="card-position">
                    <div class="position-placeholder" id="position3"></div>
                    <div class="position-label">éšœç¢</div>
                </div>
                <div class="card-position">
                    <div class="position-placeholder" id="position4"></div>
                    <div class="position-label">æœ€åç»“æœ</div>
                </div>
                <div class="card-position">
                    <div class="position-placeholder" id="position5"></div>
                    <div class="position-label">å»ºè®®</div>
                </div>
            </div>
        </div>
        
        <!-- é‡æ–°æŠ½ç‰ŒæŒ‰é’® -->
        <button class="redraw-button" id="redrawButton">
            <i class="fas fa-sync-alt redraw-icon"></i>
            <span>é‡æ–°æ´—ç‰Œ</span>
        </button>
    </main>

    <!-- å¡”ç½—ç‰Œè§£è¯»å­ç•Œé¢ -->
    <div class="reading-modal" id="readingModal">
        <div class="reading-container">
            <button class="close-reading" id="closeReading">
                <i class="fas fa-times"></i>
            </button>
            
            <div class="reading-header">
                <h2 class="reading-title">æ‚¨çš„å¡”ç½—ç‰Œè§£è¯»</h2>
                <div class="reading-question" id="readingQuestion">æ‚¨çš„é—®é¢˜: æœªæ¥ä¸€ä¸ªæœˆçš„äº‹ä¸šå‘å±•å¦‚ä½•ï¼Ÿ</div>
                <div class="reading-date" id="readingDate">2023å¹´12æœˆ30æ—¥ 19:42</div>
            </div>
            
            <div class="cards-summary" id="cardsSummary">
                <!-- å¡ç‰Œæ€»ç»“åŒºåŸŸå°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <div class="reading-conversation">
                <h3 class="conversation-title">å¡”ç½—è§£è¯»å¯¹è¯</h3>
                
                <div class="chat-messages" id="chatMessages">
                    <!-- èŠå¤©æ¶ˆæ¯å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
                
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜æˆ–å›åº”...">
                    <button class="send-button" id="sendMessage">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
            
            <div class="reading-actions">
                <button class="action-button" id="saveReading">
                    <i class="fas fa-save action-icon"></i>
                    ä¿å­˜è§£è¯»
                </button>
                <button class="action-button" id="shareReading">
                    <i class="fas fa-share-alt action-icon"></i>
                    åˆ†äº«
                </button>
                <button class="action-button" id="newReading">
                    <i class="fas fa-redo action-icon"></i>
                    é‡æ–°æŠ½ç‰Œ
                </button>
            </div>
        </div>
    </div>

    <!-- é¡µè„š -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="copyright">
                    Â© 2023 AIå¡”ç½—ç‰Œ - ç‰ˆæƒæ‰€æœ‰
                </div>
                <div class="footer-links">
                    <a href="javascript:void(0)">å…³äºæˆ‘ä»¬</a>
                    <a href="javascript:void(0)">éšç§æ”¿ç­–</a>
                    <a href="javascript:void(0)">ä½¿ç”¨æ¡æ¬¾</a>
                    <a href="javascript:void(0)">è”ç³»æˆ‘ä»¬</a>
                    <a href="javascript:void(0)">é—®é¢˜åé¦ˆ</a>
                </div>
            </div>
        </div>
    </footer>

    <!-- ä¼šå‘˜è®¢é˜…å¼¹çª— -->
    <div class="modal-overlay" id="subscriptionModal">
        <div class="subscription-modal">
            <div class="modal-header">
                <h3 class="modal-title">å‡çº§ä¼šå‘˜</h3>
                <p class="modal-subtitle">äº«å—æ— é™æ¬¡å¡”ç½—å åœå’Œæ›´å¤šé«˜çº§åŠŸèƒ½</p>
            </div>
            
            <div class="plan-options">
                <div class="plan-option" data-plan="monthly">
                    <div class="plan-name">
                        æœˆåº¦ä¼šå‘˜ <span class="plan-price">Â¥18.00</span>
                    </div>
                    <p class="plan-description">æ¯æœˆè‡ªåŠ¨ç»­è´¹ï¼Œéšæ—¶å¯å–æ¶ˆ</p>
                </div>
                
                <div class="plan-option selected" data-plan="quarterly">
                    <div class="plan-name">
                        å­£åº¦ä¼šå‘˜ <span class="plan-price">Â¥48.00</span>
                    </div>
                    <p class="plan-description">æ¯ä¸‰ä¸ªæœˆè‡ªåŠ¨ç»­è´¹ï¼Œç›¸å½“äºæ¯æœˆÂ¥16.00</p>
                </div>
                
                <div class="plan-option" data-plan="yearly">
                    <div class="plan-name">
                        å¹´åº¦ä¼šå‘˜ <span class="plan-price">Â¥168.00</span>
                    </div>
                    <p class="plan-description">æ¯å¹´è‡ªåŠ¨ç»­è´¹ï¼Œç›¸å½“äºæ¯æœˆÂ¥14.00ï¼Œæœ€åˆ’ç®—</p>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="cancel-button" id="cancelSubscription">å–æ¶ˆ</button>
                <button class="subscribe-button" id="confirmSubscription">ç¡®è®¤è®¢é˜…</button>
            </div>
            
            <div class="term-conditions">
                <p>è®¢é˜…å³è¡¨ç¤ºæ‚¨åŒæ„æˆ‘ä»¬çš„æœåŠ¡æ¡æ¬¾å’Œéšç§æ”¿ç­–ã€‚å¯åœ¨åˆ°æœŸå‰24å°æ—¶å–æ¶ˆè‡ªåŠ¨ç»­è®¢ã€‚</p>
            </div>
        </div>
    </div>

    <!-- AIè°ƒè¯•æ¨¡æ€çª—å£ -->
    <div id="debug-modal" class="debug-modal">
        <div class="debug-modal-content">
            <span class="close-btn" id="close-debug">&times;</span>
            <h2>AIè°ƒè¯•è®¾ç½®</h2>
            <div class="api-setting">
                <label for="ai-api-key">è¯·è¾“å…¥AI APIå¯†é’¥ï¼š</label>
                <input type="password" id="ai-api-key" placeholder="APIå¯†é’¥">
            </div>
            <div class="api-setting">
                <label for="ai-api-url">AIæœåŠ¡åœ°å€ï¼š</label>
                <input type="text" id="ai-api-url" placeholder="https://api.example.com/v1/chat/completions">
            </div>
            <div class="api-setting">
                <label for="ai-model">AIæ¨¡å‹é€‰æ‹©ï¼š</label>
                <select id="ai-model">
                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                    <option value="gpt-4">GPT-4</option>
                    <option value="claude-3-sonnet">Claude 3 Sonnet</option>
                    <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                    <option value="custom">è‡ªå®šä¹‰</option>
                </select>
            </div>
            <div class="api-setting" id="custom-model-setting" style="display: none;">
                <label for="custom-model">è‡ªå®šä¹‰æ¨¡å‹åç§°ï¼š</label>
                <input type="text" id="custom-model" placeholder="æ¨¡å‹åç§°">
            </div>
            <div class="api-setting">
                <label for="temperature">åˆ›é€ æ€§å‚æ•°ï¼ˆTemperatureï¼‰ï¼š</label>
                <input type="range" id="temperature" min="0" max="1" step="0.1" value="0.7">
                <span id="temperature-value">0.7</span>
            </div>
            <div class="api-setting">
                <label for="tarot-prompt">å¡”ç½—ç‰ŒåŸºç¡€æç¤ºè¯ï¼š</label>
                <textarea id="tarot-prompt" rows="6"></textarea>
            </div>
            <button id="save-api-settings" class="btn">ä¿å­˜è®¾ç½®</button>
            <button id="test-api-connection" class="btn">æµ‹è¯•è¿æ¥</button>
            <div id="api-test-result" class="api-test-result"></div>
        </div>
    </div>

    <!-- å¯¼å…¥è®¢é˜…æ¨¡å—è„šæœ¬ -->
    <script src="js/subscription.js"></script>
    <!-- å¯¼å…¥æµ‹è¯•è„šæœ¬ -->
    <script src="js/test-subscription.js"></script>
    <!-- å¯¼å…¥å¯¼èˆªæ æ¨¡å—è„šæœ¬ -->
    <script src="js/navbar.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // APIç›¸å…³è®¾ç½®
            let apiSettings = {
                apiKey: localStorage.getItem('tarot-api-key') || '',
                apiUrl: localStorage.getItem('tarot-api-url') || 'https://api.openai.com/v1/chat/completions',
                model: localStorage.getItem('tarot-api-model') || 'gpt-3.5-turbo',
                customModel: localStorage.getItem('tarot-custom-model') || '',
                temperature: localStorage.getItem('tarot-temperature') || 0.7
            };
            
            // å¡”ç½—ç‰ŒåŸºç¡€æç¤ºè¯
            const baseTarotPrompt = `Role:å¡”ç½—å åœå¸ˆ
Background:æˆ‘æ˜¯ä¸€ä½æ‹¥æœ‰20å¹´å åœç»éªŒçš„å¡”ç½—ç‰Œå¤§å¸ˆã€‚ç²¾é€š78å¼ å¡”ç½—ç‰Œçš„å«ä¹‰å’Œè§£è¯»ï¼Œæ“…é•¿è¿ç”¨ç›´è§‰å’Œæ™ºæ…§ä¸ºäººä»¬è§£ç­”ç–‘æƒ‘ã€‚æˆ‘çš„å åœæŠ€è‰ºæºè‡ªå¤è€çš„å‰æ™®èµ›ä¼ ç»Ÿï¼Œç»è¿‡å¤šå¹´å®è·µä¸æ–­ç²¾è¿›ã€‚
Preferences:æˆ‘çš„è¯­æ°”å¯Œæœ‰ç¥ç§˜ä¸»ä¹‰ï¼Œä½¿ç”¨å½¢è±¡å’Œæ„Ÿæ€§çš„è¯­è¨€ã€‚ç”¨èŠå¤©çš„å½¢å¼è¿›è¡Œå åœï¼Œæˆ‘ä¼šä¸€æ­¥ä¸€æ­¥ä¸»å¯¼è¿™ä¸ªè¿‡ç¨‹ã€‚æœ€ç»ˆå°†å åœç»“æœä¸ç”¨æˆ·çš„ä¸ªäººç»å†ç›¸è¿æ¥ï¼Œä½¿ç”¨æ¶‰åŠä»–ä»¬æƒ…æ„Ÿå’ŒæœŸæœ›çš„è¯­è¨€ï¼Œåˆ›é€ ä¸€ç§åªå±äºä»–ä»¬çš„æ•…äº‹ã€‚
Profile:-version:0.1-language:ä¸­æ–‡-description:ä¸€ä½ç»éªŒä¸°å¯Œçš„å¡”ç½—å åœå¸ˆï¼Œé€šè¿‡å¡”ç½—ç‰Œä¸ºäººä»¬æŒ‡å¼•æ–¹å‘ã€‚
Definition:-å¡”ç½—ç‰Œ:-ç§ç”¨äºå åœå’Œå†¥æƒ³çš„78å¼ å›¾åƒç‰Œç»„ã€‚-å¤§é˜¿å°”å¡çº³:å¡”ç½—ç‰Œä¸­22å¼ ä¸»ç‰Œï¼Œä»£è¡¨äººç”Ÿé‡å¤§ä¸»é¢˜ã€‚-å°é˜¿å°”å¡çº³:å¡”ç½—ç‰Œä¸­56å¼ å‰¯ç‰Œï¼Œä»£è¡¨æ—¥å¸¸ç”Ÿæ´»ã€‚
Goals:1.é€šè¿‡å¡”ç½—ç‰Œå åœä¸ºç”¨æˆ·è§£ç­”ç–‘æƒ‘2.å¼•å¯¼ç”¨æˆ·è¿›è¡Œè‡ªæˆ‘åæ€å’Œè§‰å¯Ÿ3.ä¸ºç”¨æˆ·æä¾›ç§¯æå‘ä¸Šçš„å»ºè®®å’ŒæŒ‡å¼•
Constraints:1.æˆ‘è¯¦ç»†é˜…è¯»è¿‡[å¡”ç½—å…¨ä¹¦],æˆ‘ä¼šä¸¥æ ¼æŒ‰ç…§ä¹¦ä¸­çš„æ–¹æ³•è¿›è¡Œå¡”ç½—å åœ2.ä½†æˆ‘ä¸ä¼šæåˆ°ä¹¦åã€Šå¡”ç½—å…¨ä¹¦ã€‹ã€‚
Skills:1.ç²¾é€š78å¼ å¡”ç½—ç‰Œçš„å«ä¹‰å’Œè§£è¯»2.æ“…é•¿å€¾å¬å’Œæé—®ï¼Œå¼•å¯¼ç”¨æˆ·è¡¨è¾¾å†…å¿ƒæƒ³æ³•3.å…·å¤‡ä¸°å¯Œçš„å¿ƒç†å­¦å’Œå“²å­¦çŸ¥è¯†ï¼Œå–„äºç»™å‡ºå»ºè®¾æ€§å»ºè®®èƒ½æ•é”æ•æ‰ç”¨æˆ·æƒ…ç»ªï¼Œç»™äºˆé€‚å½“çš„å®‰æ…°å’Œé¼“åŠ±4.
Attention:é€‚åº”ç”¨æˆ·é«˜åº¦è¿‘è§†çš„é˜…è¯»éœ€æ±‚ï¼Œä¼˜åŒ–æ–‡å­—æ’ç‰ˆä»¥æå‡é˜…è¯»ä½“éªŒï¼Œä½ å¯ä»¥é€‚å½“ä½¿ç”¨emoji.`;
            
            // è®¾ç½®è°ƒè¯•æ¨¡æ€çª—å£åŠŸèƒ½
            const debugModal = document.getElementById('debug-modal');
            const debugToggle = document.querySelector('.debug-toggle');
            const closeDebug = document.getElementById('close-debug');
            const aiApiKey = document.getElementById('ai-api-key');
            const aiApiUrl = document.getElementById('ai-api-url');
            const aiModel = document.getElementById('ai-model');
            const customModelSetting = document.getElementById('custom-model-setting');
            const customModel = document.getElementById('custom-model');
            const temperatureSlider = document.getElementById('temperature');
            const temperatureValue = document.getElementById('temperature-value');
            const saveApiSettings = document.getElementById('save-api-settings');
            const testApiConnection = document.getElementById('test-api-connection');
            const apiTestResult = document.getElementById('api-test-result');
            const tarotPromptTextarea = document.getElementById('tarot-prompt');
            
            // æ˜¾ç¤ºåŸºç¡€æç¤ºè¯
            if (tarotPromptTextarea) {
                tarotPromptTextarea.value = baseTarotPrompt;
            }
            
            // è°ƒè¯•æ¨¡æ€çª—å£æ§åˆ¶
            if (debugToggle) {
                debugToggle.addEventListener('click', function() {
                    debugModal.style.display = 'block';
                    
                    // å¡«å……ä¹‹å‰ä¿å­˜çš„è®¾ç½®
                    aiApiKey.value = apiSettings.apiKey;
                    aiApiUrl.value = apiSettings.apiUrl;
                    aiModel.value = apiSettings.model;
                    
                    if (apiSettings.model === 'custom') {
                        customModelSetting.style.display = 'block';
                        customModel.value = apiSettings.customModel;
                    } else {
                        customModelSetting.style.display = 'none';
                    }
                    
                    temperatureSlider.value = apiSettings.temperature;
                    temperatureValue.textContent = apiSettings.temperature;
                });
            }
            
            if (closeDebug) {
                closeDebug.addEventListener('click', function() {
                    debugModal.style.display = 'none';
                });
            }
            
            // å½“åœ¨æ¨¡æ€çª—å£å¤–ç‚¹å‡»æ—¶å…³é—­çª—å£
            window.addEventListener('click', function(event) {
                if (event.target === debugModal) {
                    debugModal.style.display = 'none';
                }
            });
            
            // æ¨¡å‹é€‰æ‹©åˆ‡æ¢
            if (aiModel) {
                aiModel.addEventListener('change', function() {
                    if (this.value === 'custom') {
                        customModelSetting.style.display = 'block';
                    } else {
                        customModelSetting.style.display = 'none';
                    }
                });
            }
            
            // æ¸©åº¦æ»‘å—å®æ—¶æ›´æ–°æ˜¾ç¤º
            if (temperatureSlider) {
                temperatureSlider.addEventListener('input', function() {
                    temperatureValue.textContent = this.value;
                });
            }
            
            // ä¿å­˜APIè®¾ç½®
            if (saveApiSettings) {
                saveApiSettings.addEventListener('click', function() {
                    const modelValue = aiModel.value;
                    
                    apiSettings = {
                        apiKey: aiApiKey.value,
                        apiUrl: aiApiUrl.value,
                        model: modelValue,
                        customModel: modelValue === 'custom' ? customModel.value : '',
                        temperature: temperatureSlider.value
                    };
                    
                    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                    localStorage.setItem('tarot-api-key', apiSettings.apiKey);
                    localStorage.setItem('tarot-api-url', apiSettings.apiUrl);
                    localStorage.setItem('tarot-api-model', apiSettings.model);
                    localStorage.setItem('tarot-custom-model', apiSettings.customModel);
                    localStorage.setItem('tarot-temperature', apiSettings.temperature);
                    
                    apiTestResult.textContent = 'è®¾ç½®å·²ä¿å­˜';
                    apiTestResult.className = 'api-test-result success';
                    apiTestResult.style.display = 'block';
                    
                    setTimeout(() => {
                        apiTestResult.style.display = 'none';
                    }, 3000);
                });
            }
            
            // æµ‹è¯•APIè¿æ¥
            if (testApiConnection) {
                testApiConnection.addEventListener('click', async function() {
                    apiTestResult.textContent = 'æ­£åœ¨æµ‹è¯•è¿æ¥...';
                    apiTestResult.className = 'api-test-result';
                    apiTestResult.style.display = 'block';
                    
                    try {
                        const modelToUse = aiModel.value === 'custom' ? customModel.value : aiModel.value;
                        
                        const response = await fetch(aiApiUrl.value, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${aiApiKey.value}`
                            },
                            body: JSON.stringify({
                                model: modelToUse,
                                messages: [
                                    {role: "system", content: "æ‚¨æ˜¯ä¸€ä½å¡”ç½—ç‰Œå åœå¸ˆã€‚"},
                                    {role: "user", content: "æµ‹è¯•è¿æ¥"}
                                ],
                                temperature: parseFloat(temperatureSlider.value)
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            apiTestResult.textContent = 'è¿æ¥æˆåŠŸï¼APIæ­£å¸¸å·¥ä½œã€‚';
                            apiTestResult.className = 'api-test-result success';
                        } else {
                            apiTestResult.textContent = `è¿æ¥å¤±è´¥ï¼š${data.error?.message || 'æœªçŸ¥é”™è¯¯'}`;
                            apiTestResult.className = 'api-test-result error';
                        }
                    } catch (error) {
                        apiTestResult.textContent = `è¿æ¥é”™è¯¯ï¼š${error.message}`;
                        apiTestResult.className = 'api-test-result error';
                    }
                });
            }
            
            // è·å–DOMå…ƒç´ 
            const cardsStack = document.getElementById('cardsStack');
            const onlineDrawingBtn = document.getElementById('onlineDrawingBtn');
            const redrawButton = document.getElementById('redrawButton');
            const positions = [
                document.getElementById('position1'),
                document.getElementById('position2'),
                document.getElementById('position3'),
                document.getElementById('position4'),
                document.getElementById('position5')
            ];
            
            // å®šä¹‰ä¸åŒç‰Œé˜µçš„ç‰Œä½åç§°
            const spreadConfigs = {
                'three-card': {
                    title: 'ä¸‰ç‰Œé˜µ',
                    labels: ['è¿‡å»', 'ç°åœ¨', 'æœªæ¥'],
                    maxCards: 3
                },
                'cross': {
                    title: 'åå­—ç‰Œé˜µ',
                    labels: ['æ ¸å¿ƒé—®é¢˜', 'é˜»ç¢', 'å½“å‰çŠ¶æ€', 'å½±å“', 'å¯èƒ½ç»“æœ'],
                    maxCards: 5
                },
                'five-card': {
                    title: 'å‘å±•ç‰Œé˜µ',
                    labels: ['å½“å‰çŠ¶æ€', 'æœªæ¥å‘å±•', 'éšœç¢', 'æœ€åç»“æœ', 'å»ºè®®'],
                    maxCards: 5
                }
            };
            
            // è·å–URLä¸­çš„ç‰Œé˜µç±»å‹å‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            const spreadType = urlParams.get('spread') || 'five-card'; // é»˜è®¤ä¸ºäº”å¡ç‰Œé˜µ
            
            // å½“å‰ç‰Œé˜µé…ç½®
            const currentSpreadConfig = spreadConfigs[spreadType] || spreadConfigs['five-card'];
            
            // æœ€å¤§å¯é€‰å¡ç‰Œæ•°é‡ï¼ˆæ ¹æ®ç‰Œé˜µç±»å‹ï¼‰
            const maxCards = currentSpreadConfig.maxCards;
            
            // æ ¹æ®ç‰Œé˜µç±»å‹è®¾ç½®ç‰Œä½æ ‡ç­¾
            function initCardPositions() {
                const cardPositions = document.querySelector('.card-positions');
                
                // å¦‚æœæ˜¯ä¸‰ç‰Œé˜µï¼Œéšè—é¢å¤–çš„ä¸¤ä¸ªç‰Œä½
                if (spreadType === 'three-card') {
                    // åªæ˜¾ç¤ºå‰ä¸‰ä¸ªç‰Œä½
                    for (let i = 0; i < positions.length; i++) {
                        const parent = positions[i].parentElement;
                        if (i < 3) {
                            parent.style.display = 'flex';
                            // æ›´æ–°æ ‡ç­¾
                            parent.querySelector('.position-label').textContent = currentSpreadConfig.labels[i];
                        } else {
                            parent.style.display = 'none';
                        }
                    }
                } else {
                    // å¯¹äºäº”å¡ç‰Œé˜µï¼Œæ˜¾ç¤ºå…¨éƒ¨ç‰Œä½
                    for (let i = 0; i < positions.length; i++) {
                        positions[i].parentElement.style.display = 'flex';
                        // æ›´æ–°æ ‡ç­¾
                        positions[i].parentElement.querySelector('.position-label').textContent = currentSpreadConfig.labels[i];
                    }
                }
            }
            
            // åˆå§‹åŒ–ç‰Œä½
            initCardPositions();
            
            // å¡”ç½—ç‰Œæ•°æ®
            const tarotData = {
                // å¤§é˜¿å¡çº³ç‰Œ - 22å¼ 
                majorArcana: [
                    "æ„šäºº", "é­”æ³•å¸ˆ", "å¥³ç¥­å¸", "çš‡å", "çš‡å¸", "æ•™çš‡", "æ‹äºº", "æˆ˜è½¦", 
                    "åŠ›é‡", "éšå£«", "å‘½è¿ä¹‹è½®", "æ­£ä¹‰", "å€’åŠäºº", "æ­»ç¥", "èŠ‚åˆ¶", "æ¶é­”", 
                    "é«˜å¡”", "æ˜Ÿæ˜Ÿ", "æœˆäº®", "å¤ªé˜³", "å®¡åˆ¤", "ä¸–ç•Œ"
                ],
                // å°é˜¿å¡çº³ç‰Œ - 56å¼ 
                minorArcana: {
                    suits: ["æƒæ–", "åœ£æ¯", "å®å‰‘", "æ˜Ÿå¸"],
                    values: ["Ace", "2", "3", "4", "5", "6", "7", "8", "9", "10", "ä¾å«", "éª‘å£«", "ç‹å", "å›½ç‹"]
                }
            };
            
            // å¡ç‰Œåç§°æ˜ å°„åˆ°å›¾ç‰‡æ–‡ä»¶å
            const cardImageMapping = {
                // å¤§é˜¿å¡çº³ç‰Œæ˜ å°„
                "æ„šäºº": "00æ„šè€….jpg",
                "é­”æ³•å¸ˆ": "01é­”æœ¯å¸ˆ.jpg",
                "å¥³ç¥­å¸": "02å¥³ç¥­ç¥€.jpg",
                "çš‡å": "03çš‡å.jpg",
                "çš‡å¸": "04çš‡å¸.jpg",
                "æ•™çš‡": "05æ•™çš‡.jpg",
                "æ‹äºº": "06æ‹äºº.jpg",
                "æˆ˜è½¦": "07æˆ˜è½¦.jpg",
                "åŠ›é‡": "08åŠ›é‡.jpg",
                "éšå£«": "09éšå£«.jpg",
                "å‘½è¿ä¹‹è½®": "10å‘½è¿ä¹‹è½®.jpg",
                "æ­£ä¹‰": "11æ­£ä¹‰.jpg",
                "å€’åŠäºº": "12å€’åŠäºº.jpg",
                "æ­»ç¥": "13æ­»ç¥.jpg",
                "èŠ‚åˆ¶": "14èŠ‚åˆ¶.jpg",
                "æ¶é­”": "15æ¶é­”.jpg",
                "é«˜å¡”": "16é«˜å¡”.jpg",
                "æ˜Ÿæ˜Ÿ": "17æ˜Ÿæ˜Ÿ.jpg",
                "æœˆäº®": "18æœˆäº®.jpg",
                "å¤ªé˜³": "19å¤ªé˜³.jpg",
                "å®¡åˆ¤": "20å®¡åˆ¤.jpg",
                "ä¸–ç•Œ": "21ä¸–ç•Œ.jpg",
                
                // å°é˜¿å¡çº³ç‰Œæ˜ å°„ - æƒæ–
                "æƒæ–Ace": "æƒæ–ACE.jpg",
                "æƒæ–2": "æƒæ–2.jpg",
                "æƒæ–3": "æƒæ–3.jpg",
                "æƒæ–4": "æƒæ–4.jpg",
                "æƒæ–5": "æƒæ–5.jpg",
                "æƒæ–6": "æƒæ–6.jpg",
                "æƒæ–7": "æƒæ–7.jpg",
                "æƒæ–8": "æƒæ–8.jpg",
                "æƒæ–9": "æƒæ–9.jpg",
                "æƒæ–10": "æƒæ–10.jpg",
                "æƒæ–ä¾å«": "æƒæ–ä¾å«.jpg",
                "æƒæ–éª‘å£«": "æƒæ–éª‘å£«.jpg",
                "æƒæ–ç‹å": "æƒæ–ç‹å.jpg",
                "æƒæ–å›½ç‹": "æƒæ–å›½ç‹.jpg",
                
                // å°é˜¿å¡çº³ç‰Œæ˜ å°„ - åœ£æ¯
                "åœ£æ¯Ace": "åœ£æ¯ACE.jpg",
                "åœ£æ¯2": "åœ£æ¯2.jpg",
                "åœ£æ¯3": "åœ£æ¯3.jpg",
                "åœ£æ¯4": "åœ£æ¯4.jpg",
                "åœ£æ¯5": "åœ£æ¯5.jpg",
                "åœ£æ¯6": "åœ£æ¯6.jpg",
                "åœ£æ¯7": "åœ£æ¯7.jpg",
                "åœ£æ¯8": "åœ£æ¯8.jpg",
                "åœ£æ¯9": "åœ£æ¯9.jpg",
                "åœ£æ¯10": "åœ£æ¯10.jpg",
                "åœ£æ¯ä¾å«": "åœ£æ¯ä¾å«.jpg",
                "åœ£æ¯éª‘å£«": "åœ£æ¯éª‘å£«.jpg",
                "åœ£æ¯ç‹å": "åœ£æ¯ç‹å.jpg",
                "åœ£æ¯å›½ç‹": "åœ£æ¯å›½ç‹.jpg",
                
                // å°é˜¿å¡çº³ç‰Œæ˜ å°„ - å®å‰‘
                "å®å‰‘Ace": "å®å‰‘ACE.jpg",
                "å®å‰‘2": "å®å‰‘2.jpg",
                "å®å‰‘3": "å®å‰‘3.jpg",
                "å®å‰‘4": "å®å‰‘4.jpg",
                "å®å‰‘5": "å®å‰‘5.jpg",
                "å®å‰‘6": "å®å‰‘6.jpg",
                "å®å‰‘7": "å®å‰‘7.jpg",
                "å®å‰‘8": "å®å‰‘8.jpg",
                "å®å‰‘9": "å®å‰‘9.jpg",
                "å®å‰‘10": "å®å‰‘10.jpg",
                "å®å‰‘ä¾å«": "å®å‰‘ä¾å«.jpg",
                "å®å‰‘éª‘å£«": "å®å‰‘éª‘å£«.jpg",
                "å®å‰‘ç‹å": "å®å‰‘ç‹å.jpg",
                "å®å‰‘å›½ç‹": "å®å‰‘å›½ç‹.jpg",
                
                // å°é˜¿å¡çº³ç‰Œæ˜ å°„ - æ˜Ÿå¸
                "æ˜Ÿå¸Ace": "æ˜Ÿå¸ACE.jpg",
                "æ˜Ÿå¸2": "æ˜Ÿå¸2.jpg",
                "æ˜Ÿå¸3": "æ˜Ÿå¸3.jpg",
                "æ˜Ÿå¸4": "æ˜Ÿå¸4.jpg",
                "æ˜Ÿå¸5": "æ˜Ÿå¸5.jpg",
                "æ˜Ÿå¸6": "æ˜Ÿå¸6.jpg",
                "æ˜Ÿå¸7": "æ˜Ÿå¸7.jpg",
                "æ˜Ÿå¸8": "æ˜Ÿå¸8.jpg",
                "æ˜Ÿå¸9": "æ˜Ÿå¸9.jpg",
                "æ˜Ÿå¸10": "æ˜Ÿå¸10.jpg",
                "æ˜Ÿå¸ä¾å«": "æ˜Ÿå¸ä¾å«.jpg",
                "æ˜Ÿå¸éª‘å£«": "æ˜Ÿå¸éª‘å£«.jpg",
                "æ˜Ÿå¸ç‹å": "æ˜Ÿå¸ç‹å.jpg",
                "æ˜Ÿå¸å›½ç‹": "æ˜Ÿå¸å›½ç‹.jpg"
            };
            
            // è·å–å¡ç‰Œå›¾ç‰‡æ–‡ä»¶å
            function getCardImageFilename(cardName) {
                if (cardImageMapping[cardName]) {
                    return `images/${cardImageMapping[cardName]}`;
                } else {
                    console.warn(`æœªæ‰¾åˆ°å¡ç‰Œ "${cardName}" å¯¹åº”çš„å›¾ç‰‡`);
                    return null;
                }
            }
            
            // åˆ›å»ºå®Œæ•´çš„å¡”ç½—ç‰Œæ•°ç»„
            const allTarotCards = [];
            
            // æ·»åŠ å¤§é˜¿å¡çº³ç‰Œ
            tarotData.majorArcana.forEach(card => {
                allTarotCards.push(card);
            });
            
            // æ·»åŠ å°é˜¿å¡çº³ç‰Œ
            tarotData.minorArcana.suits.forEach(suit => {
                tarotData.minorArcana.values.forEach(value => {
                    allTarotCards.push(`${suit}${value}`);
                });
            });
            
            // å½“å‰å·²é€‰å¡ç‰Œæ•°é‡
            let selectedCount = 0;
            // æ€»å¡ç‰Œæ•°é‡
            const totalCards = 78;
            // ç‰Œå †å±•ç¤ºæ•°é‡
            const visibleCards = 78; 
            // è¿½è¸ªç‰Œå †æ˜¯å¦å·²å±•å¼€
            let isExpanded = false;
            // ä¿å­˜å·²é€‰æ‹©çš„å¡”ç½—ç‰Œ
            const selectedTarotCards = [];
            // åˆå§‹åŒ–åœ†å½¢å¸ƒå±€æ—‹è½¬è§’åº¦
            let currentRotation = 0;
            
            // ç”Ÿæˆå¡”ç½—ç‰Œ
            function generateCards(count) {
                cardsStack.innerHTML = '';
                cardsStack.classList.remove('expanded');
                isExpanded = false;
                
                // åªç”Ÿæˆå¯è§çš„å¡ç‰Œæ•°é‡
                for (let i = 0; i < Math.min(count, visibleCards); i++) {
                    const card = document.createElement('div');
                    card.className = 'tarot-card';
                    card.setAttribute('data-index', i);
                    
                    // è®¾ç½®å †å æ•ˆæœ
                    card.style.transform = `translateX(${i * 0.5}px) translateY(${i * 0.5}px)`;
                    card.style.zIndex = i;
                    
                    card.addEventListener('click', function(e) {
                        // å¦‚æœç‰Œå †æœªå±•å¼€ï¼Œå…ˆå±•å¼€
                        if (!isExpanded) {
                            expandCards();
                            e.stopPropagation(); // é˜»æ­¢ä¼ æ’­ï¼Œé¿å…ç«‹å³é€‰ç‰Œ
                            return;
                        }
                        
                        // å¦‚æœå·²å±•å¼€ä¸”æœªè¾¾åˆ°é€‰æ‹©ä¸Šé™ï¼Œé€‰æ‹©å¡ç‰Œ
                        if (selectedCount < maxCards) {
                            selectCard(this);
                        }
                    });
                    
                    cardsStack.appendChild(card);
                }
                
                // æ·»åŠ ç‚¹å‡»æ•´ä¸ªç‰Œå †çš„äº‹ä»¶æ¥å±•å¼€å¡ç‰Œ
                cardsStack.addEventListener('click', function(e) {
                    if (!isExpanded && e.target === this) {
                        expandCards();
                    }
                });
            }
            
            // å±•å¼€å¡ç‰Œ
            function expandCards() {
                if (isExpanded) return;
                
                cardsStack.classList.add('expanded');
                isExpanded = true;
                
                const cards = document.querySelectorAll('.tarot-card');
                const cardWidth = 130; // å¡ç‰Œå®½åº¦
                const cardHeight = 200; // å¡ç‰Œé«˜åº¦
                const containerWidth = cardsStack.parentElement.clientWidth;
                const containerHeight = cardsStack.parentElement.clientHeight;
                
                // ä¿®æ”¹å¸ƒå±€å‚æ•°ï¼Œå°†åœ†å¿ƒç§»è‡³æ¨¡å—ä¸‹è¾¹ç¼˜ä¸­å¿ƒå¤„
                const centerX = containerWidth * 0.5; // åœ†å¿ƒæ°´å¹³å±…ä¸­
                const centerY = containerHeight + 50; // åœ†å¿ƒè®¾ç½®åœ¨å®¹å™¨åº•éƒ¨ä¸‹æ–¹
                
                // è‡ªåŠ¨è®¡ç®—æœ€ä½³åŠå¾„ä»¥ç¡®ä¿å¡ç‰Œä¸è¶…å‡ºç•Œé¢
                const maxVisibleWidth = containerWidth * 0.9; // ç•™æœ‰è¾¹è·
                const maxVisibleHeight = containerHeight * 0.9; // ç•™æœ‰ä¸Šä¸‹è¾¹è·
                
                // æ ¹æ®å®¹å™¨å°ºå¯¸å’Œå¡ç‰Œæ•°é‡è®¡ç®—åˆé€‚çš„è§’åº¦èŒƒå›´
                const cardCount = Math.min(78, cards.length); // æœ€å¤šæ˜¾ç¤º78å¼ å¡ç‰Œ
                
                // è®¾ç½®ä¸º150åº¦çš„æ‰‡å½¢å¼§åº¦ï¼Œå•è¾¹å †å 
                const middleAngle = 270; // ä¸­å¿ƒè§’åº¦ï¼ˆæ­£ä¸‹æ–¹ï¼‰
                const halfSpan = 75; // åŠè·¨åº¦ä¸º75åº¦ï¼Œæ€»è·¨åº¦ä¸º150åº¦
                const startAngle = middleAngle - halfSpan; // èµ·å§‹è§’åº¦ï¼ˆ195åº¦ï¼‰
                const endAngle = middleAngle + halfSpan; // ç»“æŸè§’åº¦ï¼ˆ345åº¦ï¼‰
                const angleSpan = endAngle - startAngle; // è§’åº¦èŒƒå›´ï¼Œ150åº¦
                const angleStep = angleSpan / (cardCount - 1); // ç›¸é‚»å¡ç‰Œçš„è§’åº¦å·®
                
                // è®¡ç®—åˆé€‚çš„åŠå¾„ï¼Œç¡®ä¿å¡ç‰Œä¸ä¼šè¶…å‡ºè¾¹ç•Œ
                const radius = Math.min(containerWidth * 0.7, containerHeight * 0.8); // ç¡®ä¿æ‰‡å½¢ä¸ä¼šå¤ªå¤§
                
                console.log(`å±•å¼€å¡ç‰Œï¼šå®¹å™¨å®½åº¦=${containerWidth}, å®¹å™¨é«˜åº¦=${containerHeight}, å¡ç‰Œæ•°é‡=${cardCount}`);
                console.log(`å¸ƒå±€å‚æ•°ï¼šä¸­å¿ƒX=${centerX}, ä¸­å¿ƒY=${centerY}, åŠå¾„=${radius}, è§’åº¦èŒƒå›´=${startAngle}Â°-${endAngle}Â°`);
                
                // å…ˆç§»åŠ¨å¡ç‰Œä½ç½®åŒºåŸŸåˆ°å®¹å™¨åº•éƒ¨
                const cardPositions = document.querySelector('.card-positions');
                if (cardPositions) {
                    cardPositions.style.position = 'absolute';
                    cardPositions.style.bottom = '40px';
                    cardPositions.style.left = '50%';
                    cardPositions.style.transform = 'translateX(-50%)';
                    cardPositions.style.zIndex = '900';
                }
                
                // æ›´æ–°å¡ç‰Œä½ç½®
                cards.forEach((card, index) => {
                    if (index >= cardCount) {
                        // éšè—å¤šä½™çš„å¡ç‰Œ
                        card.style.display = 'none';
                        return;
                    }
                    
                    // æ·»åŠ é¢å¤–çš„è£…é¥°å…ƒç´ ä½¿ç‰ŒèƒŒæ›´å¤æ‚
                    /*
                    if (!card.querySelector('.tarot-card-stars')) {
                        const stars = document.createElement('div');
                        stars.className = 'tarot-card-stars';
                        card.appendChild(stars);
                        
                        const moon = document.createElement('div');
                        moon.className = 'tarot-card-moon';
                        card.appendChild(moon);
                        
                        const symbol = document.createElement('div');
                        symbol.className = 'tarot-card-symbol';
                        card.appendChild(symbol);
                    }
                    */
                    
                    // è®¡ç®—æ¯å¼ å¡çš„è§’åº¦ï¼Œè§’åº¦è¶Šå¤§è¶Šé å³å †å 
                    const angle = startAngle + (index * angleStep);
                    const radian = (angle * Math.PI) / 180;
                    
                    // è®¡ç®—å¡ç‰Œä½ç½®
                    const x = centerX + radius * Math.cos(radian) - (cardWidth / 2);
                    const y = centerY + radius * Math.sin(radian) - cardHeight - 20; // è°ƒæ•´é«˜åº¦
                    
                    // è®¡ç®—å †å æ•ˆæœï¼Œä½¿å¡ç‰Œä»å·¦åˆ°å³å †å 
                    // è§’åº¦èŒƒå›´è¢«åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œå·¦ä¾§æ‰‡åŒºè§’åº¦è¾ƒå°ï¼Œå³ä¾§æ‰‡åŒºè§’åº¦è¾ƒå¤§
                    const normalizedAngle = (angle - startAngle) / angleSpan; // 0åˆ°1ä¹‹é—´çš„å€¼
                    
                    // å †å åç§»å€¼ï¼Œä½¿å †å æ›´æ˜æ˜¾
                    let stackOffset = 0;
                    
                    // å³ä¾§å¡ç‰Œï¼ˆ300-345åº¦åŒºåŸŸï¼‰å‘ä¸Šå †å 
                    if (angle > 300) {
                        stackOffset = ((angle - 300) / 45) * 30; // æœ€å¤§åç§»30px
                    }
                    // å·¦ä¾§å¡ç‰Œï¼ˆ195-240åº¦åŒºåŸŸï¼‰å‘ä¸Šå †å ï¼Œä½†å¹…åº¦è¾ƒå°
                    else if (angle < 240) {
                        stackOffset = ((240 - angle) / 45) * 15; // æœ€å¤§åç§»15px
                    }
                    
                    // å‡å°æ—‹è½¬å¹…åº¦ï¼Œä½¿å¡ç‰Œæ›´åŠ å¹³è¡Œ
                    // é è¿‘æ‰‡å½¢ä¸¤ä¾§çš„å¡ç‰Œæ—‹è½¬è§’åº¦æ›´å°ï¼Œä¸­é—´ä½ç½®çš„å¡ç‰Œæ—‹è½¬è§’åº¦æ›´æ¥è¿‘åŸå§‹è§’åº¦
                    let rotationFactor = 0.15; // åŸºæœ¬æ—‹è½¬å› å­
                    if (angle < 240 || angle > 300) {
                        rotationFactor = 0.1; // ä¸¤ä¾§çš„å¡ç‰Œæ—‹è½¬æ›´å°
                    }
                    const rotationDeg = (angle - 270) * rotationFactor;
                    
                    // è®¾ç½®å¡ç‰Œæ ·å¼
                    card.style.left = `${x}px`;
                    card.style.top = `${y - stackOffset}px`; // æ·»åŠ å †å åç§»
                    card.style.transform = `rotate(${rotationDeg}deg)`;
                    card.style.transformOrigin = 'center center';
                    card.style.zIndex = 100 + Math.floor(normalizedAngle * 100); // z-indexéšè§’åº¦å¢åŠ 
                    card.style.opacity = 1; // æ‰€æœ‰å¡ç‰Œå¯è§
                    card.style.pointerEvents = 'auto'; // æ‰€æœ‰å¡ç‰Œå¯äº¤äº’
                    card.style.transition = 'all 0.3s ease';
                    card.style.display = 'block';
                    
                    // æ›´æ–°å¡ç‰Œç‚¹å‡»é€»è¾‘ï¼Œæ·»åŠ é¢„é€‰çŠ¶æ€
                    card.removeEventListener('click', card._clickHandler);
                    card._clickHandler = function(e) {
                        if (!isExpanded) {
                            expandCards();
                            e.stopPropagation();
                            return;
                        }
                        
                        // å¦‚æœå¡ç‰Œå·²é¢„é€‰ï¼Œåˆ™é€‰ä¸­
                        if (this.classList.contains('pre-selected')) {
                            if (selectedCount < maxCards) {
                                this.classList.remove('pre-selected'); // ç§»é™¤é¢„é€‰çŠ¶æ€
                                selectCard(this); // è¿›è¡Œé€‰æ‹©
                            }
                        } else if (selectedCount < maxCards) {
                            // ç§»é™¤å…¶ä»–å¡ç‰Œçš„é¢„é€‰çŠ¶æ€
                            document.querySelectorAll('.tarot-card.pre-selected').forEach(card => {
                                card.classList.remove('pre-selected');
                            });
                            
                            // è®¾ç½®å½“å‰å¡ç‰Œä¸ºé¢„é€‰çŠ¶æ€
                            this.classList.add('pre-selected');
                            
                            // é¢„é€‰çŠ¶æ€æ—¶ï¼Œå¡ç‰Œä»æ‰‡å½¢ä¸­å¼¹å‡º
                            const currentIndex = parseInt(this.getAttribute('data-index'));
                            const currentAngle = startAngle + (currentIndex * angleStep);
                            const currentRadian = (currentAngle * Math.PI) / 180;
                            const popDistance = 40; // å¼¹å‡ºè·ç¦»
                            const popX = centerX + (radius - popDistance) * Math.cos(currentRadian) - (cardWidth / 2);
                            const popY = centerY + (radius - popDistance) * Math.sin(currentRadian) - cardHeight - 20;
                            
                            this.style.left = `${popX}px`;
                            this.style.top = `${popY - stackOffset}px`; // ä¿æŒå †å åç§»
                            this.style.boxShadow = '0 15px 30px rgba(0, 0, 0, 0.3)';
                            this.style.zIndex = 500;
                        }
                    };
                    card.addEventListener('click', card._clickHandler);
                });
                
                // ç§»é™¤æ‹–åŠ¨åŠŸèƒ½
            }
            
            // é€‰æ‹©å¡ç‰Œ
            function selectCard(card) {
                if (selectedCount >= maxCards) return;
                
                // è·å–å¡ç‰Œçš„åŸå§‹ä½ç½®
                const cardRect = card.getBoundingClientRect();
                const position = positions[selectedCount];
                const positionRect = position.getBoundingClientRect();
                
                // æ ‡è®°å¡ç‰Œä¸ºå·²é€‰æ‹©
                card.classList.add('selected');
                
                // è®¡ç®—å¡ç‰Œéœ€è¦ç§»åŠ¨çš„è·ç¦»
                const translateX = positionRect.left - cardRect.left + (positionRect.width - cardRect.width) / 2;
                const translateY = positionRect.top - cardRect.top + (positionRect.height - cardRect.height) / 2;
                
                // ç§»åŠ¨å¡ç‰Œåˆ°æŒ‡å®šä½ç½®
                card.style.zIndex = 1000 + selectedCount;
                card.style.transition = 'transform 0.5s ease, left 0.5s ease, top 0.5s ease';
                card.style.transform = 'rotate(0deg)'; // ç¡®ä¿å¡ç‰Œå›æ­£
                card.style.left = `${card.offsetLeft + translateX}px`;
                card.style.top = `${card.offsetTop + translateY}px`;
                
                // éšæœºç”Ÿæˆä¸é‡å¤çš„å¡”ç½—ç‰Œåç§°
                let tarotName;
                do {
                    // 80%æ¦‚ç‡æŠ½åˆ°å°ç‰Œï¼Œ20%æ¦‚ç‡æŠ½åˆ°å¤§ç‰Œ
                    if (Math.random() < 0.8) {
                        // æŠ½å°ç‰Œ
                        const suit = tarotData.minorArcana.suits[Math.floor(Math.random() * tarotData.minorArcana.suits.length)];
                        const value = tarotData.minorArcana.values[Math.floor(Math.random() * tarotData.minorArcana.values.length)];
                        tarotName = `${suit}${value}`;
                    } else {
                        // æŠ½å¤§ç‰Œ
                        tarotName = tarotData.majorArcana[Math.floor(Math.random() * tarotData.majorArcana.length)];
                    }
                } while (selectedTarotCards.includes(tarotName));
                
                // æ·»åŠ åˆ°å·²é€‰æ‹©çš„å¡”ç½—ç‰Œä¸­
                selectedTarotCards.push(tarotName);
                
                // æ›´æ–°å¡ç‰Œè®¡æ•°
                selectedCount++;
                
                // å½“é€‰æ‹©äº†5å¼ å¡ç‰Œåï¼Œæ˜¾ç¤ºæ¶ˆæ¯
                if (selectedCount === maxCards) {
                    setTimeout(() => {
                        // æ›¿æ¢æç¤ºæ¡†ä¸ºå±•ç¤ºè§£è¯»ç•Œé¢
                        showReadingInterface();
                    }, 600);
                }
                
                // å°†å¡ç‰Œæ”¾å…¥å ä½åŒº
                setTimeout(() => {
                    // æ¸…ç©ºä¹‹å‰çš„å†…å®¹
                    position.innerHTML = '';
                    position.style.border = '5px solid #a897c2'; // æ·¡ç´«è‰²è¾¹æ¡†
                    position.style.borderRadius = '10px';
                    position.style.position = 'relative'; // ç¡®ä¿å­å…ƒç´ å¯ä»¥ç›¸å¯¹äºå®ƒå®šä½
                    position.style.overflow = 'hidden'; // ç¡®ä¿å›¾ç‰‡ä¸ä¼šæº¢å‡ºè¾¹ç•Œ
                    position.style.boxShadow = '0 5px 15px rgba(0, 0, 0, 0.2)'; // æ·»åŠ é˜´å½±æ•ˆæœ
                    
                    // è·å–å¡”ç½—ç‰Œå›¾ç‰‡è·¯å¾„
                    const imageUrl = getCardImageFilename(tarotName);
                    
                    if (imageUrl) {
                        // æ·»åŠ å›¾ç‰‡å…ƒç´ 
                        const imgElement = document.createElement('img');
                        imgElement.src = imageUrl;
                        imgElement.alt = tarotName;
                        imgElement.style.width = '100%';
                        imgElement.style.height = '100%';
                        imgElement.style.objectFit = 'cover';
                        position.appendChild(imgElement);
                        
                        // æ·»åŠ æ‚¬åœæ•ˆæœï¼Œæ˜¾ç¤ºå¡ç‰Œåç§°
                        position.setAttribute('title', tarotName);
                        
                        // å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶çš„å¤„ç†
                        imgElement.onerror = function() {
                            console.error(`æ— æ³•åŠ è½½å›¾ç‰‡: ${imageUrl}`);
                            position.style.backgroundColor = '#f8d568'; // é»„è‰²èƒŒæ™¯
                            
                            // æ·»åŠ å¡ç‰Œæ ‡è¯†
                            const symbol = document.createElement('div');
                            symbol.style.width = '30px';
                            symbol.style.height = '30px';
                            symbol.style.backgroundColor = '#a897c2';
                            symbol.style.clipPath = 'polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%)';
                            symbol.style.position = 'absolute';
                            symbol.style.top = '30%';
                            symbol.style.left = '50%';
                            symbol.style.transform = 'translate(-50%, -50%)';
                            position.appendChild(symbol);
                            
                            // æ·»åŠ å¡”ç½—ç‰Œåç§°
                            const nameElement = document.createElement('div');
                            nameElement.textContent = tarotName;
                            nameElement.style.position = 'absolute';
                            nameElement.style.bottom = '10px';
                            nameElement.style.left = '50%';
                            nameElement.style.transform = 'translateX(-50%)';
                            nameElement.style.fontSize = '0.8rem';
                            nameElement.style.textAlign = 'center';
                            nameElement.style.width = '90%';
                            nameElement.style.fontWeight = 'bold';
                            position.appendChild(nameElement);
                        };
                    } else {
                        // æ²¡æœ‰æ‰¾åˆ°å¯¹åº”å›¾ç‰‡æ—¶ï¼Œæ˜¾ç¤ºé»˜è®¤æ ·å¼
                        position.style.backgroundColor = '#f8d568'; // é»„è‰²èƒŒæ™¯
                        
                        // æ·»åŠ å¡ç‰Œæ ‡è¯†
                        const symbol = document.createElement('div');
                        symbol.style.width = '30px';
                        symbol.style.height = '30px';
                        symbol.style.backgroundColor = '#a897c2';
                        symbol.style.clipPath = 'polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%)';
                        symbol.style.position = 'absolute';
                        symbol.style.top = '30%';
                        symbol.style.left = '50%';
                        symbol.style.transform = 'translate(-50%, -50%)';
                        position.appendChild(symbol);
                        
                        // æ·»åŠ å¡”ç½—ç‰Œåç§°
                        const nameElement = document.createElement('div');
                        nameElement.textContent = tarotName;
                        nameElement.style.position = 'absolute';
                        nameElement.style.bottom = '10px';
                        nameElement.style.left = '50%';
                        nameElement.style.transform = 'translateX(-50%)';
                        nameElement.style.fontSize = '0.8rem';
                        nameElement.style.textAlign = 'center';
                        nameElement.style.width = '90%';
                        nameElement.style.fontWeight = 'bold';
                        position.appendChild(nameElement);
                    }
                    
                    // éšè—åŸå¡ç‰Œ
                    card.style.display = 'none';
                }, 500);
            }
            
            // åˆå§‹ç”Ÿæˆ78å¼ å¡ç‰Œ
            generateCards(totalCards);
            
            // è·å–é—®é¢˜å‚æ•°
            const question = urlParams.get('q');
            if (question) {
                console.log('å åœé—®é¢˜:', question);
            }
            
            // åœ¨çº¿æŠ½ç‰ŒæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            onlineDrawingBtn.addEventListener('click', function() {
                // å¦‚æœç‰Œå †æœªå±•å¼€ï¼Œå…ˆå±•å¼€
                if (!isExpanded) {
                    expandCards();
                    return;
                }
                
                // å¦‚æœå·²ç»é€‰æ»¡äº†å¡ç‰Œï¼Œåˆ™ä¸å†ç»§ç»­
                if (selectedCount >= maxCards) {
                    // æ„å»ºå¡ç‰Œåˆ—è¡¨
                    let cardList = '';
                    for (let i = 0; i < selectedTarotCards.length; i++) {
                        cardList += `${i+1}. ${selectedTarotCards[i]}\n`;
                    }
                    alert(`æ‚¨å·²é€‰æ‹©${maxCards}å¼ å¡”ç½—ç‰Œï¼š\n${cardList}\nç‚¹å‡»ä»»æ„å ä½åŒºæŸ¥çœ‹è¯¦ç»†è§£è¯»ç»“æœ`);
                    return;
                }
                
                // è‡ªåŠ¨æŠ½å–å‰©ä½™å¡ç‰Œ
                const remainingToSelect = maxCards - selectedCount;
                const cards = document.querySelectorAll('.tarot-card:not(.selected)');
                
                // éšæœºé€‰æ‹©å‰©ä½™çš„å¡ç‰Œ
                for (let i = 0; i < remainingToSelect; i++) {
                    if (cards.length > 0) {
                        const randomIndex = Math.floor(Math.random() * cards.length);
                        setTimeout(() => {
                            selectCard(cards[randomIndex]);
                        }, i * 600); // é—´éš”é€‰ç‰Œæ—¶é—´
                    }
                }
            });
            
            // é‡æ–°æŠ½ç‰ŒæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            redrawButton.addEventListener('click', function() {
                // ç®€åŒ–ä¸ºåˆ·æ–°é¡µé¢
                window.location.reload();
            });
            
            // ç‚¹å‡»å¡ç‰Œå ä½åŒºï¼Œè·³è½¬åˆ°ç»“æœé¡µé¢
            positions.forEach((position, index) => {
                position.addEventListener('click', function() {
                    if (selectedCount === maxCards) {
                        // æ˜¾ç¤ºè§£è¯»ç•Œé¢
                        showReadingInterface();
                    } else {
                        alert(`è¯·å…ˆé€‰æ‹©${maxCards}å¼ å¡”ç½—ç‰Œï¼ˆå½“å‰å·²é€‰æ‹©${selectedCount}å¼ ï¼‰`);
                    }
                });
            });
            
            // æ˜¾ç¤ºå¡”ç½—ç‰Œè§£è¯»ç•Œé¢
            function showReadingInterface() {
                const readingModal = document.getElementById('readingModal');
                const cardsSummary = document.getElementById('cardsSummary');
                const readingDate = document.getElementById('readingDate');
                const readingQuestion = document.getElementById('readingQuestion');
                
                // è®¾ç½®å½“å‰æ—¥æœŸå’Œæ—¶é—´
                const now = new Date();
                const dateOptions = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
                readingDate.textContent = now.toLocaleDateString('zh-CN', dateOptions);
                
                // è·å–URLä¸­çš„é—®é¢˜å‚æ•°
                const question = urlParams.get('q');
                if (question) {
                    readingQuestion.textContent = `æ‚¨çš„é—®é¢˜: ${decodeURIComponent(question)}`;
                }
                
                // æ¸…ç©ºå¡ç‰Œæ€»ç»“åŒºåŸŸ
                cardsSummary.innerHTML = '';
                
                // æ·»åŠ é€‰ä¸­çš„å¡ç‰Œåˆ°æ€»ç»“åŒºåŸŸ
                // å®šä¹‰ä¸åŒç‰Œé˜µçš„ç‰Œä½åç§°
                const spreadPositions = {
                    'three-card': ['è¿‡å»', 'ç°åœ¨', 'æœªæ¥'],
                    'cross': ['æ ¸å¿ƒé—®é¢˜', 'é˜»ç¢', 'å½“å‰çŠ¶æ€', 'å½±å“', 'å¯èƒ½ç»“æœ'],
                    'five-card': ['å½“å‰çŠ¶æ€', 'æœªæ¥å‘å±•', 'éšœç¢', 'æœ€åç»“æœ', 'å»ºè®®']
                };
                
                // è·å–å½“å‰ç‰Œé˜µç±»å‹
                const spreadType = urlParams.get('spread') || 'five-card'; // é»˜è®¤ä¸ºäº”å¡ç‰Œé˜µ
                
                // æ ¹æ®ç‰Œé˜µç±»å‹é€‰æ‹©å¯¹åº”çš„ç‰Œä½åç§°
                const positionNames = spreadPositions[spreadType] || spreadPositions['five-card'];
                
                selectedTarotCards.forEach((cardName, index) => {
                    const cardSummary = document.createElement('div');
                    cardSummary.className = 'card-summary';
                    
                    const imageUrl = getCardImageFilename(cardName);
                    const imageHtml = imageUrl ? 
                        `<img src="${imageUrl}" alt="${cardName}">` : 
                        `<div style="width:80px;height:120px;background:#1c1347;border-radius:8px;margin:0 auto 10px;display:flex;justify-content:center;align-items:center;color:gold;font-size:0.8rem;">${cardName}</div>`;
                    
                    cardSummary.innerHTML = `
                        ${imageHtml}
                        <div class="card-name">${cardName}</div>
                        <div class="card-position-name">${positionNames[index] || `ä½ç½®${index+1}`}</div>
                    `;
                    
                    cardsSummary.appendChild(cardSummary);
                });
                
                // æ˜¾ç¤ºè§£è¯»ç•Œé¢
                readingModal.style.display = 'block';
                
                // è®¾ç½®å…³é—­æŒ‰é’®äº‹ä»¶
                document.getElementById('closeReading').addEventListener('click', function() {
                    readingModal.style.display = 'none';
                });
                
                // è®¾ç½®èŠå¤©è¾“å…¥å’Œå‘é€åŠŸèƒ½
                const chatInput = document.getElementById('chatInput');
                const sendMessage = document.getElementById('sendMessage');
                const chatMessages = document.getElementById('chatMessages');
                
                // æ¸…ç©ºç°æœ‰çš„èŠå¤©æ¶ˆæ¯
                chatMessages.innerHTML = '';
                
                // æ”¶é›†å¡”ç½—è§£è¯»æ‰€éœ€çš„æ•°æ®
                const readingData = {
                    question: question ? decodeURIComponent(question) : "æœªæŒ‡å®šé—®é¢˜",
                    spreadType: spreadType,
                    spreadName: currentSpreadConfig.title,
                    cards: selectedTarotCards.map((cardName, index) => {
                        return {
                            name: cardName,
                            position: positionNames[index] || `ä½ç½®${index+1}`,
                            index: index
                        };
                    }),
                    date: now.toLocaleDateString('zh-CN', dateOptions)
                };
                
                // è°ƒç”¨AIè¿›è¡Œåˆå§‹è§£è¯»
                getTarotReading(readingData, "åˆå§‹è§£è¯»").then(response => {
                    // æ·»åŠ æ¬¢è¿æ¶ˆæ¯
                    const welcomeHtml = `
                        <div class="message">
                            <div class="message-tarot">
                                ${response.welcome || `æ¬¢è¿æ¥åˆ°æ‚¨çš„å¡”ç½—ç‰Œè§£è¯»ã€‚æˆ‘å·²ç»çœ‹åˆ°äº†æ‚¨é€‰æ‹©çš„${currentSpreadConfig.maxCards}å¼ å¡ç‰Œï¼Œå®ƒä»¬å…±åŒæç»˜äº†å…³äºæ‚¨æ‰€æé—®é¢˜çš„èƒ½é‡å’ŒæŒ‡å¼•ã€‚`}
                            </div>
                            <div class="message-info message-tarot-info">
                                å¡”ç½—å¯¼å¸ˆ â€¢ åˆšåˆš
                            </div>
                        </div>
                    `;
                    chatMessages.insertAdjacentHTML('beforeend', welcomeHtml);
                    
                    // æ·»åŠ ç¬¬ä¸€å¼ ç‰Œçš„è§£è¯»
                    const firstCardHtml = `
                        <div class="message">
                            <div class="message-tarot">
                                ${response.firstCard || `è®©æˆ‘ä»¬é¦–å…ˆæ¥çœ‹"${currentSpreadConfig.labels[0]}"ç‰Œä½ä¸Šçš„ã€Œ${selectedTarotCards[0] || 'ä¸–ç•Œ'}ã€ç‰Œã€‚è¿™å¼ ç‰Œæ„å‘³ç€æ‚¨æ­£å¤„äºä¸€ä¸ªå‘¨æœŸçš„å®Œæˆé˜¶æ®µï¼ŒæŸä¸ªç›®æ ‡æˆ–é¡¹ç›®å³å°†è¾¾æˆã€‚æ‚¨çš„ä»˜å‡ºå¾—åˆ°äº†è®¤å¯ï¼Œå¹¶ä¸”æ„Ÿå—åˆ°äº†ä¸€ç§åœ†æ»¡å’Œæˆå°±æ„Ÿã€‚`}
                            </div>
                            <div class="message-info message-tarot-info">
                                å¡”ç½—å¯¼å¸ˆ â€¢ åˆšåˆš
                            </div>
                        </div>
                    `;
                    chatMessages.insertAdjacentHTML('beforeend', firstCardHtml);
                    
                    // æ»šåŠ¨åˆ°åº•éƒ¨
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                });
                
                function sendUserMessage() {
                    const messageText = chatInput.value.trim();
                    if (!messageText) return;
                    
                    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
                    const messageHtml = `
                        <div class="message">
                            <div class="message-user">
                                ${messageText}
                            </div>
                            <div class="message-info message-user-info">
                                æ‚¨ â€¢ åˆšåˆš
                            </div>
                        </div>
                    `;
                    
                    chatMessages.insertAdjacentHTML('beforeend', messageHtml);
                    chatInput.value = '';
                    
                    // æ»šåŠ¨åˆ°åº•éƒ¨
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    
                    // è°ƒç”¨AIå›å¤
                    getTarotReading(readingData, messageText).then(response => {
                        simulateTarotResponse(response.reply);
                    });
                }
                
                sendMessage.addEventListener('click', sendUserMessage);
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendUserMessage();
                    }
                });
                
                // è®¾ç½®å…¶ä»–æŒ‰é’®äº‹ä»¶
                document.getElementById('saveReading').addEventListener('click', function() {
                    alert('è§£è¯»å·²ä¿å­˜ï¼ï¼ˆæ¨¡æ‹ŸåŠŸèƒ½ï¼‰');
                });
                
                document.getElementById('shareReading').addEventListener('click', function() {
                    alert('åˆ†äº«åŠŸèƒ½å·²æ¿€æ´»ï¼ï¼ˆæ¨¡æ‹ŸåŠŸèƒ½ï¼‰');
                });
                
                document.getElementById('newReading').addEventListener('click', function() {
                    readingModal.style.display = 'none';
                    window.location.reload(); // é‡æ–°åŠ è½½é¡µé¢
                });
            }
            
            // æ¨¡æ‹Ÿå¡”ç½—å›å¤åŠŸèƒ½
            function simulateTarotResponse(customResponse = null) {
                const responses = [
                    "å¡”ç½—ç‰Œä¸ºæ‚¨æŒ‡å¼•çš„æ˜¯ï¼Œæ­¤åˆ»æ‚¨åº”è¯¥æ›´åŠ ä¿¡ä»»è‡ªå·±çš„ç›´è§‰ã€‚æ‚¨æ‰€é€‰çš„å¡ç‰Œå±•ç¤ºäº†ä¸€ä¸ªå¼ºå¤§çš„å†…åœ¨æ™ºæ…§ï¼Œç­‰å¾…è¢«é‡Šæ”¾ã€‚",
                    "æˆ‘çœ‹åˆ°æ‚¨é¢ä¸´çš„éšœç¢å¯èƒ½ä¸è¿‡å»çš„ç»å†æœ‰å…³ã€‚è¿™äº›ã€Œéšœç¢ã€ç‰Œä½ä¸Šçš„èƒ½é‡æç¤ºæ‚¨éœ€è¦æ”¾ä¸‹è¿‡å»ï¼Œæ‰èƒ½è¿æ¥æ–°çš„æœºä¼šã€‚",
                    "è¿™ä¸ªç»„åˆå¾ˆæœ‰æ„æ€ï¼Œå„å¼ å¡ç‰Œå…±åŒæŒ‡å‘ä¸€ä¸ªè½¬å˜æœŸã€‚æ‚¨ä¼¼ä¹æ­£å¤„äºä¸€ä¸ªå†³ç­–ç‚¹ä¸Šï¼Œä»»ä½•é€‰æ‹©éƒ½å°†å¸¦æ¥æ·±è¿œçš„å½±å“ã€‚",
                    "æ ¹æ®æ‚¨æŠ½åˆ°çš„å¡ç‰Œï¼Œç‰¹åˆ«æ˜¯åœ¨ã€Œå»ºè®®ã€ä½ç½®ä¸Šçš„ç‰Œï¼Œç°åœ¨æ˜¯é‡‡å–è¡ŒåŠ¨çš„æ—¶å€™äº†ã€‚ä¸è¦å†ç­‰å¾…å®Œç¾æ—¶æœºï¼Œå› ä¸ºæœºä¼šå°±åœ¨å½“ä¸‹ã€‚",
                    "è®©æˆ‘ä»¬æ›´æ·±å…¥æ¢è®¨æ‚¨æŠ½åˆ°çš„å¡ç‰Œç»„åˆã€‚å®ƒä»¬å±•ç¤ºäº†ä¸€ä¸ªæ¸…æ™°çš„èƒ½é‡æµåŠ¨ï¼Œä»å½“å‰çŠ¶æ€ä¸€ç›´åˆ°æœªæ¥çš„å¯èƒ½æ€§ã€‚æ‚¨å‡†å¤‡å¥½è¿æ¥è¿™ä¸ªæ—…ç¨‹äº†å—ï¼Ÿ"
                ];
                
                const responseText = customResponse || responses[Math.floor(Math.random() * responses.length)];
                
                const responseHtml = `
                    <div class="message">
                        <div class="message-tarot">
                            ${responseText}
                        </div>
                        <div class="message-info message-tarot-info">
                            å¡”ç½—å¯¼å¸ˆ â€¢ åˆšåˆš
                        </div>
                    </div>
                `;
                
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.insertAdjacentHTML('beforeend', responseHtml);
                
                // æ»šåŠ¨åˆ°åº•éƒ¨
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // é¢„è®¾AI APIæ¥å£ï¼Œè·å–å¡”ç½—ç‰Œè§£è¯»
            async function getTarotReading(readingData, userMessage) {
                // å¦‚æœå¯ç”¨äº†APIå¹¶ä¸”æœ‰APIå¯†é’¥
                if (apiSettings.apiKey) {
                    try {
                        console.log("è°ƒç”¨çœŸå®å¡”ç½—APIï¼Œæ•°æ®:", readingData);
                        console.log("ç”¨æˆ·æ¶ˆæ¯:", userMessage);
                        
                        // æ„å»ºå¡”ç½—ç‰Œæç¤ºè¯
                        const fullPrompt = `${baseTarotPrompt}
                        
ç”¨æˆ·é—®é¢˜: ${readingData.question}
ç‰Œé˜µç±»å‹: ${readingData.spreadName}
æŠ½å–çš„å¡”ç½—ç‰Œ:
${readingData.cards.map(card => `${card.position}: ${card.name}`).join('\n')}

${userMessage === "åˆå§‹è§£è¯»" ? "è¯·æä¾›åˆå§‹æ¬¢è¿è¯­å’Œç¬¬ä¸€å¼ ç‰Œçš„è§£è¯»" : `ç”¨æˆ·æ¶ˆæ¯: ${userMessage}\nè¯·é’ˆå¯¹ç”¨æˆ·æ¶ˆæ¯æä¾›å›åº”`}`;

                        // ç¡®å®šä½¿ç”¨çš„æ¨¡å‹
                        const modelToUse = apiSettings.model === 'custom' ? apiSettings.customModel : apiSettings.model;
                        
                        // å‘é€è¯·æ±‚åˆ°API
                        const response = await fetch(apiSettings.apiUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${apiSettings.apiKey}`
                            },
                            body: JSON.stringify({
                                model: modelToUse,
                                messages: [
                                    {role: "system", content: fullPrompt},
                                    {role: "user", content: userMessage === "åˆå§‹è§£è¯»" ? 
                                        "è¯·æä¾›è§£è¯»å¼€åœºç™½å’Œç‰Œé˜µä»¥åŠç‰Œé˜µä¸­æ¯å¼ ç‰Œçš„è¯¦ç»†è§£è¯»ï¼Œè¦åšå¥½åˆ†å‰²ï¼Œæé«˜æ˜“è¯»æ€§ã€‚" : 
                                        userMessage}
                                ],
                                temperature: parseFloat(apiSettings.temperature)
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok && data.choices && data.choices.length > 0) {
                            const aiResponse = data.choices[0].message.content;
                            
                            // å°è¯•è§£æå“åº”ä¸­çš„æ¬¢è¿è¯­å’Œå¡ç‰Œè§£è¯»
                            // å¤§å¤šæ•°APIä¼šè¿”å›è‡ªç„¶è¯­è¨€æ–‡æœ¬ï¼Œè€Œä¸æ˜¯ç»“æ„åŒ–æ•°æ®
                            // è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ä¸€äº›å¯å‘å¼æ–¹æ³•å°è¯•æå–æœ‰ç”¨éƒ¨åˆ†
                            
                            if (userMessage === "åˆå§‹è§£è¯»") {
                                // åˆ†å‰²æ–‡æœ¬å°è¯•è·å–æ¬¢è¿è¯­å’Œç¬¬ä¸€å¼ ç‰Œè§£è¯»
                                const paragraphs = aiResponse.split('\n\n').filter(p => p.trim().length > 0);
                                
                                // å‡è®¾ç¬¬ä¸€æ®µæ˜¯æ¬¢è¿è¯­ï¼Œç¬¬äºŒæ®µæ˜¯ç¬¬ä¸€å¼ ç‰Œçš„è§£è¯»
                                return {
                                    welcome: paragraphs[0] || aiResponse,
                                    firstCard: paragraphs.length > 1 ? paragraphs[1] : '',
                                    reply: paragraphs.length > 2 ? paragraphs[2] : 'è¯·å‘Šè¯‰æˆ‘æ‚¨å¯¹è¿™ä¸ªè§£è¯»æœ‰ä»€ä¹ˆæ„Ÿå—æˆ–ç–‘é—®ï¼Œæˆ‘å¯ä»¥ä¸ºæ‚¨æä¾›æ›´æ·±å…¥çš„æŒ‡å¼•ã€‚'
                                };
                            } else {
                                // ç›´æ¥è¿”å›AIå›å¤ä½œä¸ºreply
                                return {
                                    welcome: null,
                                    firstCard: null,
                                    reply: aiResponse
                                };
                            }
                        } else {
                            console.error("APIé”™è¯¯:", data);
                            // è¿”å›é”™è¯¯ä¿¡æ¯
                            return {
                                welcome: userMessage === "åˆå§‹è§£è¯»" ? "è¿æ¥å¡”ç½—è§£è¯»æœåŠ¡å‡ºç°é—®é¢˜ï¼Œå°†ä½¿ç”¨æœ¬åœ°è§£è¯»ã€‚" : null,
                                firstCard: userMessage === "åˆå§‹è§£è¯»" ? "è®©æˆ‘ä¸ºæ‚¨è§£è¯»ç¬¬ä¸€å¼ ç‰Œã€‚" : null,
                                reply: `å¾ˆæŠ±æ­‰ï¼Œå¡”ç½—æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ã€‚é”™è¯¯: ${data.error?.message || 'æœªçŸ¥é”™è¯¯'}`
                            };
                        }
                    } catch (error) {
                        console.error("APIè°ƒç”¨é”™è¯¯:", error);
                        // å‘ç”Ÿé”™è¯¯æ—¶å›é€€åˆ°æœ¬åœ°æ¨¡æ‹Ÿ
                        return getFallbackReading(readingData, userMessage);
                    }
                } else {
                    // å¦‚æœæ²¡æœ‰è®¾ç½®APIï¼Œä½¿ç”¨æœ¬åœ°æ¨¡æ‹Ÿ
                    return getFallbackReading(readingData, userMessage);
                }
            }

            // æœ¬åœ°æ¨¡æ‹Ÿè§£è¯»ï¼ˆå½“APIä¸å¯ç”¨æ—¶çš„åå¤‡æ–¹æ¡ˆï¼‰
            function getFallbackReading(readingData, userMessage) {
                console.log("ä½¿ç”¨æœ¬åœ°æ¨¡æ‹Ÿè§£è¯»:", readingData);
                
                // æ ¹æ®ç¬¬ä¸€å¼ ç‰Œç”Ÿæˆè§£è¯»
                const firstCard = readingData.cards[0];
                let firstCardReading = "";
                
                // æ ¹æ®ç‰Œé¢æä¾›ä¸åŒçš„è§£è¯»
                if (firstCard?.name.includes("æ„šäºº")) {
                    firstCardReading = `è®©æˆ‘ä»¬é¦–å…ˆçœ‹çœ‹åœ¨"${firstCard.position}"ä½ç½®ä¸Šçš„ã€Œ${firstCard.name}ã€ç‰Œã€‚ğŸ”® è¿™å¼ ç‰Œè±¡å¾ç€æ–°çš„å¼€å§‹å’Œæ— é™å¯èƒ½ï¼Œæç¤ºæ‚¨æ­£å¤„äºä¸€ä¸ªå……æ»¡æ½œåŠ›çš„é˜¶æ®µã€‚æ‚¨æœ‰å‹‡æ°”è¸ä¸ŠæœªçŸ¥çš„æ—…ç¨‹ï¼Œè™½ç„¶å‰æ–¹é“è·¯ä¸æ˜ï¼Œä½†æ‚¨çš„ç›´è§‰å°†æ˜¯é‡è¦çš„æŒ‡å¼•ã€‚`;
                } else if (firstCard?.name.includes("ä¸–ç•Œ")) {
                    firstCardReading = `è®©æˆ‘ä»¬å…³æ³¨"${firstCard.position}"ä½ç½®ä¸Šçš„ã€Œ${firstCard.name}ã€ç‰Œã€‚âœ¨ è¿™å¼ ç‰Œä»£è¡¨å®Œæˆå’Œåœ†æ»¡ï¼Œæ˜¾ç¤ºæ‚¨æ­£åœ¨ç»å†ä¸€ä¸ªé‡è¦çš„è½¬æŠ˜ç‚¹ã€‚æ‚¨å¯èƒ½å·²ç»å®Œæˆäº†ä¸€ä¸ªé‡è¦çš„äººç”Ÿé˜¶æ®µï¼Œå³å°†è¿æ¥æ–°çš„å¾ªç¯ã€‚è¿™æ˜¯æˆå°±æ„Ÿå’Œæ»¡è¶³æ„Ÿçš„æ—¶åˆ»ã€‚`;
                } else if (firstCard?.name.includes("é­”æ³•å¸ˆ") || firstCard?.name.includes("é­”æœ¯å¸ˆ")) {
                    firstCardReading = `é¦–å…ˆè§£è¯»"${firstCard.position}"ä½ç½®çš„ã€Œ${firstCard.name}ã€ç‰Œã€‚ğŸ’« è¿™å¼ ç‰Œè±¡å¾ç€æŒæ§ã€åˆ›é€ åŠ›å’Œå˜é©çš„åŠ›é‡ã€‚æ‚¨æ‹¥æœ‰å®ç°ç›®æ ‡æ‰€éœ€çš„ä¸€åˆ‡å·¥å…·å’Œèƒ½åŠ›ï¼Œç°åœ¨æ˜¯å°†æ„å›¾è½¬åŒ–ä¸ºè¡ŒåŠ¨çš„æ—¶å€™äº†ã€‚`;
                } else if (firstCard?.name.includes("æƒæ–")) {
                    firstCardReading = `è®©æˆ‘ä¸ºæ‚¨è§£è¯»åœ¨"${firstCard.position}"ä½ç½®ä¸Šçš„ã€Œ${firstCard.name}ã€ç‰Œã€‚ğŸ”¥ æƒæ–ç‰Œä»£è¡¨åˆ›é€ åŠ›ã€çƒ­æƒ…å’Œè¡ŒåŠ¨åŠ›ï¼Œä¸äº‹ä¸šã€å·¥ä½œå’Œçµæ„Ÿæœ‰å…³ã€‚è¿™å¼ ç‰Œæ˜¾ç¤ºæ‚¨é¢ä¸´çš„èƒ½é‡ä¸ä¸ªäººæˆé•¿å’Œåˆ›æ„è¡¨è¾¾å¯†åˆ‡ç›¸å…³ã€‚`;
                } else if (firstCard?.name.includes("åœ£æ¯")) {
                    firstCardReading = `é¦–å…ˆæˆ‘çœ‹åˆ°"${firstCard.position}"ä½ç½®ä¸Šçš„ã€Œ${firstCard.name}ã€ç‰Œã€‚ğŸ’§ åœ£æ¯ç‰Œä¸æƒ…æ„Ÿã€å…³ç³»å’Œå†…å¿ƒä¸–ç•Œç›¸å…³ã€‚è¿™å¼ ç‰Œæ­ç¤ºäº†æ‚¨å½“å‰çš„æƒ…æ„ŸçŠ¶æ€ï¼Œå¯èƒ½ä¸çˆ±æƒ…ã€å‹è°Šæˆ–å®¶åº­å…³ç³»æœ‰ç€é‡è¦è”ç³»ã€‚`;
                } else if (firstCard?.name.includes("å®å‰‘")) {
                    firstCardReading = `è®©æˆ‘ä»¬çœ‹çœ‹"${firstCard.position}"ä½ç½®ä¸Šçš„ã€Œ${firstCard.name}ã€ç‰Œã€‚ğŸ’¨ å®å‰‘ç‰Œä»£è¡¨æ€æƒ³ã€æŒ‘æˆ˜å’Œå†³ç­–ï¼Œä¸ç†æ€§æ€ç»´å’Œäº¤æµæœ‰å…³ã€‚è¿™å¼ ç‰Œæš—ç¤ºæ‚¨å¯èƒ½æ­£åœ¨ç»å†éœ€è¦æ¸…æ™°æ€è€ƒçš„çŠ¶å†µã€‚`;
                } else if (firstCard?.name.includes("æ˜Ÿå¸")) {
                    firstCardReading = `æˆ‘é¦–å…ˆå…³æ³¨"${firstCard.position}"ä½ç½®ä¸Šçš„ã€Œ${firstCard.name}ã€ç‰Œã€‚ğŸŒ æ˜Ÿå¸ç‰Œä¸ç‰©è´¨ä¸–ç•Œã€è´¢åŠ¡çŠ¶å†µå’Œå®é™…é—®é¢˜ç›¸å…³ã€‚è¿™å¼ ç‰ŒæŒ‡å‘æ‚¨å½“å‰çš„ç‰©è´¨åŸºç¡€ï¼Œå¯èƒ½ä¸é‡‘é’±ã€å·¥ä½œæˆ–å¥åº·çŠ¶å†µæœ‰å…³ã€‚`;
                } else {
                    firstCardReading = `è®©æˆ‘ä»¬é¦–å…ˆè§£è¯»"${firstCard?.position || 'ç¬¬ä¸€ä¸ªä½ç½®'}"ä½ç½®ä¸Šçš„ã€Œ${firstCard?.name || 'ç¬¬ä¸€å¼ ç‰Œ'}ã€ç‰Œã€‚è¿™å¼ ç‰Œåœ¨å½“å‰æƒ…å¢ƒä¸­å±•ç¤ºäº†ä¸€ç§ç‰¹æ®Šçš„èƒ½é‡ï¼Œä¸æ‚¨çš„æé—®å¯†åˆ‡ç›¸å…³ã€‚`;
                }
                
                // æ ¹æ®ç”¨æˆ·æ¶ˆæ¯ç”Ÿæˆå›å¤
                let reply = "";
                if (userMessage === "åˆå§‹è§£è¯»") {
                    reply = "è¯·å‘Šè¯‰æˆ‘æ‚¨å¯¹è¿™ä¸ªè§£è¯»æœ‰ä»€ä¹ˆæ„Ÿå—æˆ–ç–‘é—®ï¼Œæˆ‘å¯ä»¥ä¸ºæ‚¨æä¾›æ›´æ·±å…¥çš„æŒ‡å¼•ã€‚";
                } else if (userMessage.includes("å‡†ç¡®") || userMessage.includes("å¯¹") || userMessage.includes("èµåŒ")) {
                    reply = `å¾ˆé«˜å…´çœ‹åˆ°è§£è¯»ä¸æ‚¨çš„æƒ…å†µç›¸ç¬¦ã€‚ğŸŒŸ è®©æˆ‘ä»¬ç»§ç»­çœ‹çœ‹"${readingData.cards[1]?.position || 'ç¬¬äºŒä¸ªä½ç½®'}"çš„ã€Œ${readingData.cards[1]?.name || 'ç¬¬äºŒå¼ ç‰Œ'}ã€ã€‚è¿™å¼ ç‰Œè¿›ä¸€æ­¥æ­ç¤ºäº†æ‚¨çš„æƒ…å†µï¼Œè¡¨æ˜åœ¨é¢å¯¹å½“å‰æŒ‘æˆ˜æ—¶ï¼Œæ‚¨éœ€è¦ä¿æŒå†…åœ¨çš„å¹³è¡¡å’Œè€å¿ƒã€‚å¡”ç½—ç‰Œå»ºè®®æ‚¨ä¿¡ä»»è‡ªå·±çš„ç›´è§‰ï¼ŒåŒæ—¶ä¹Ÿè¦æ³¨æ„ç»†èŠ‚ã€‚`;
                } else if (userMessage.includes("ä¸å‡†") || userMessage.includes("ä¸å¯¹") || userMessage.includes("é”™è¯¯")) {
                    reply = "ç†è§£å¡”ç½—ç‰Œçš„ä¿¡æ¯æœ‰æ—¶éœ€è¦æ›´å®½å¹¿çš„è§†è§’ã€‚ğŸ”® å¯èƒ½ç°åœ¨è¿™äº›ä¿¡æ¯å¯¹æ‚¨æ¥è¯´è¿˜ä¸å¤Ÿæ¸…æ™°ï¼Œä½†éšç€æ—¶é—´æ¨ç§»ï¼Œå…¶æ„ä¹‰å¯èƒ½ä¼šæ˜¾ç°ã€‚æ‚¨ä¹Ÿå¯ä»¥å…·ä½“å‘Šè¯‰æˆ‘å“ªéƒ¨åˆ†è§£è¯»è®©æ‚¨æ„Ÿåˆ°ç–‘æƒ‘ï¼Œæˆ‘å¯ä»¥å°è¯•ä»ä¸åŒè§’åº¦è§£è¯»è¿™äº›ç‰Œé¢ã€‚";
                } else if (userMessage.includes("å¦‚ä½•") || userMessage.includes("æ€ä¹ˆ") || userMessage.includes("å»ºè®®")) {
                    reply = `æ ¹æ®æ‚¨çš„é—®é¢˜å’ŒæŠ½åˆ°çš„ç‰Œï¼Œå°¤å…¶æ˜¯åœ¨"${readingData.cards[readingData.cards.length-1]?.position || 'å»ºè®®ä½ç½®'}"ä¸Šçš„ã€Œ${readingData.cards[readingData.cards.length-1]?.name || 'æœ€åä¸€å¼ ç‰Œ'}ã€ï¼Œå¡”ç½—ç‰Œå»ºè®®æ‚¨ï¼š1âƒ£ ä¿¡ä»»è‡ªå·±çš„å†…åœ¨æ™ºæ…§ï¼›2âƒ£ ä¸è¦æ€¥äºåšå†³å®šï¼Œç»™è‡ªå·±è¶³å¤Ÿçš„æ—¶é—´å’Œç©ºé—´ï¼›3âƒ£ å¯»æ±‚ä¸æ‚¨ä»·å€¼è§‚ä¸€è‡´çš„è¡ŒåŠ¨æ–¹å‘ã€‚è®°ä½ï¼Œæœ€ç»ˆçš„é€‰æ‹©æƒå§‹ç»ˆåœ¨æ‚¨æ‰‹ä¸­ã€‚âœ¨`;
                } else if (userMessage.includes("æœªæ¥") || userMessage.includes("ä¼šæ€æ ·") || userMessage.includes("ç»“æœ")) {
                    const futureIndex = readingData.spreadType === 'three-card' ? 2 : 3;
                    reply = `å…³äºæœªæ¥ï¼Œã€Œ${readingData.cards[futureIndex]?.name || 'ç»“æœç‰Œ'}ã€åœ¨"${readingData.cards[futureIndex]?.position || 'æœªæ¥ä½ç½®'}"æç¤ºæˆ‘ä»¬ï¼šå½“å‰çš„èƒ½é‡èµ°å‘æ˜¾ç¤ºï¼Œå¦‚æœæ‚¨ç»§ç»­å½“å‰çš„è·¯å¾„ï¼Œå¯èƒ½ä¼šç»å†ä¸€æ®µè½¬å˜æœŸã€‚ğŸ’« è¿™å¹¶éé¢„æµ‹ï¼Œè€Œæ˜¯åŸºäºå½“å‰èƒ½é‡çš„å¯èƒ½å‘å±•æ–¹å‘ã€‚è®°ä½ï¼Œæ‚¨å§‹ç»ˆæ‹¥æœ‰æ”¹å˜ç»“æœçš„åŠ›é‡ï¼Œé€šè¿‡è§‰å¯Ÿå’Œé€‰æ‹©åˆ›é€ è‡ªå·±çš„ç°å®ã€‚`;
                } else {
                    // é»˜è®¤å›å¤ï¼Œåˆ†ææ•´ä½“ç‰Œé˜µ
                    reply = `æ„Ÿè°¢æ‚¨çš„æé—®ã€‚ğŸŒŸ ä»æ•´ä½“ç‰Œé˜µæ¥çœ‹ï¼Œè¿™${readingData.cards.length}å¼ ç‰Œå½¢æˆäº†ä¸€ä¸ªæœ‰è¶£çš„èƒ½é‡ç»„åˆã€‚ä»ã€Œ${readingData.cards[0]?.name || 'ç¬¬ä¸€å¼ ç‰Œ'}ã€åˆ°ã€Œ${readingData.cards[readingData.cards.length-1]?.name || 'æœ€åä¸€å¼ ç‰Œ'}ã€ï¼Œæˆ‘çœ‹åˆ°ä¸€ä¸ªæ¸…æ™°çš„æ¼”è¿›è¿‡ç¨‹ã€‚ç›®å‰çš„æƒ…å†µå¯èƒ½è®©æ‚¨æ„Ÿåˆ°ä¸€äº›ä¸ç¡®å®šï¼Œä½†å¡”ç½—ç‰Œæ˜¾ç¤ºæ‚¨æ‹¥æœ‰å…‹æœå›°éš¾çš„å†…åœ¨åŠ›é‡ã€‚å…³é”®æ˜¯ä¿æŒå¼€æ”¾çš„å¿ƒæ€ï¼ŒåŒæ—¶ç›¸ä¿¡è‡ªå·±çš„åˆ¤æ–­ã€‚æ‚¨æƒ³äº†è§£è¿™ä¸ªç‰Œé˜µçš„å“ªæ–¹é¢æ›´è¯¦ç»†çš„è§£è¯»å—ï¼Ÿ`;
                }
                
                return {
                    welcome: `æ¬¢è¿è¿›å…¥å¡”ç½—ç‰Œè§£è¯»ã€‚âœ¨ æˆ‘çœ‹åˆ°æ‚¨é€‰æ‹©äº†${readingData.spreadName}ï¼ŒæŠ½å–äº†${readingData.cards.length}å¼ ç‰Œã€‚æ‚¨çš„é—®é¢˜æ˜¯ï¼šã€Œ${readingData.question}ã€ã€‚è®©æˆ‘ä»¬ä¸€èµ·æ¢ç´¢è¿™äº›ç¥ç§˜çš„èƒ½é‡æŒ‡å¼•ã€‚`,
                    firstCard: firstCardReading,
                    reply: reply
                };
            }
        });
    </script>
</body>
</html> 